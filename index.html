<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Financieel Planner</title>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React en ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel Standalone voor JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
  </style>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary': '#10b981',
            'primary-dark': '#059669',
            'secondary': '#3b82f6',
            'accent': '#f59e0b',
            'dark': '#1f2937',
            'light': '#f9fafb',
          }
        }
      }
    }
  </script>
</head>
<body class="bg-light">
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // ============================================
    // FINANCIAL ENGINE - INLINE VERSION
    // ============================================
    
    // From assumptions.js
    const defaultAssumptions = Object.freeze({
      inflationRate: 2.0,
      investmentReturn: 7.0,
      safeWithdrawalRate: 4.0,
      targetNetWorth: 1_500_000,
    });
    
    // From helpers.js
    const yearlyAmount = (amount, frequency) => {
      if (typeof amount !== 'number' || isNaN(amount) || amount < 0) {
        throw new Error('amount must be a non-negative number');
      }
      return frequency === 'monthly' ? amount * 12 : amount;
    };
    
    const isActiveInYear = (item, year) => {
      if (!item || typeof item.startYear !== 'number') {
        return false;
      }
      return (
        year >= item.startYear &&
        (!item.endYear || year <= item.endYear)
      );
    };
    
    const grow = (value, rate, years) => {
      if (
        typeof value !== 'number' || isNaN(value) || value < 0 ||
        typeof rate !== 'number' || isNaN(rate) ||
        typeof years !== 'number' || isNaN(years) || years < 0
      ) {
        throw new Error('value, rate and years must be valid numbers (value ‚â• 0, years ‚â• 0)');
      }
      const safeYears = Math.max(0, years); // Prevent negative years
      const multiplier = Math.pow(1 + rate / 100, safeYears);
      const result = value * multiplier;
      return Number(result.toFixed(2));
    };
    
    // From tax.js
    const TAX_BRACKETS_2026 = [
      { limit: 38883, rate: 35.75 },
      { limit: 78426, rate: 37.56 },
      { limit: Infinity, rate: 49.5 }
    ];
    
    const TAX_CREDITS_2026 = Object.freeze({
      algemeneMax: 3115,
      algemeneAfbouwStart: 29739,
      algemeneAfbouwPercentage: 6.398,
      arbeidMax: 5685,
      arbeidBuildRateLow: 8.324,
      arbeidLowThreshold: 11965,
      arbeidPhaseoutStart: 45592,
      arbeidPhaseoutRate: 6.51
    });
    
    // Toeslagen 2026 constanten
    const TOESLAGEN_2026 = {
      KINDGEBONDEN_BUDGET: {
        PER_KIND: 2580,
        DREMPEL_ENKEL: 29736,
        DREMPEL_PARTNER: 39141,
        AFBOUW_PERC: 0.076,
        INFLATION_LAG: 1 // Toeslagen stijgen met 1 jaar vertraging
      },
      KINDERBIJSLAG: {
        LEEFTIJD_0_5: { kwartaal: 295.07, perc: '70%' },
        LEEFTIJD_6_11: { kwartaal: 358.30, perc: '85%' },
        LEEFTIJD_12_17: { kwartaal: 421.53, perc: '100%' },
        INFLATION_LAG: 1
     },
      KINDEROPVANG: {
        MAX_UREN_MAAND: 230,
        TYPES: {
          dagopvang: 11.23,
          bso: 9.98,
          gastouder: 8.49
        },
        INFLATION_LAG: 1
      },
      IACK: {
        DREMPEL: 6239,
        MAX: 3032,
        FACTOR: 0.1145,
        INFLATION_LAG: 1
      }
    };

    const KINDEROPVANG_SCHIJVEN = [
      { van: 0, tot: 24149, percEerste: 0.960, percVolgend: 0.960 },
      { van: 24150, tot: 25756, percEerste: 0.960, percVolgend: 0.960 },
      { van: 25757, tot: 27363, percEerste: 0.960, percVolgend: 0.960 },
      { van: 27364, tot: 28973, percEerste: 0.960, percVolgend: 0.960 },
      { van: 28974, tot: 30579, percEerste: 0.960, percVolgend: 0.960 },
      { van: 30580, tot: 32189, percEerste: 0.960, percVolgend: 0.960 },
      { van: 32190, tot: 33795, percEerste: 0.960, percVolgend: 0.960 },
      { van: 33796, tot: 35400, percEerste: 0.960, percVolgend: 0.960 },
      { van: 35401, tot: 37129, percEerste: 0.960, percVolgend: 0.960 },
      { van: 37130, tot: 38855, percEerste: 0.960, percVolgend: 0.960 },
      { van: 38856, tot: 40586, percEerste: 0.960, percVolgend: 0.960 },
      { van: 40587, tot: 42313, percEerste: 0.960, percVolgend: 0.960 },
      { van: 42314, tot: 44046, percEerste: 0.960, percVolgend: 0.960 },
      { van: 44047, tot: 45776, percEerste: 0.960, percVolgend: 0.960 },
      { van: 45777, tot: 47546, percEerste: 0.960, percVolgend: 0.960 },
      { van: 47547, tot: 49318, percEerste: 0.960, percVolgend: 0.960 },
      { van: 49319, tot: 51092, percEerste: 0.960, percVolgend: 0.960 },
      { van: 51093, tot: 52864, percEerste: 0.960, percVolgend: 0.960 },
      { van: 52865, tot: 54641, percEerste: 0.960, percVolgend: 0.960 },
      { van: 54642, tot: 56412, percEerste: 0.960, percVolgend: 0.960 },
      { van: 56413, tot: 58184, percEerste: 0.955, percVolgend: 0.956 },
      { van: 58185, tot: 59957, percEerste: 0.948, percVolgend: 0.956 },
      { van: 59958, tot: 61895, percEerste: 0.939, percVolgend: 0.956 },
      { van: 61896, tot: 65695, percEerste: 0.924, percVolgend: 0.956 },
      { van: 65696, tot: 69492, percEerste: 0.916, percVolgend: 0.952 },
      { van: 69493, tot: 73292, percEerste: 0.905, percVolgend: 0.946 },
      { van: 73293, tot: 77094, percEerste: 0.882, percVolgend: 0.942 },
      { van: 77095, tot: 80891, percEerste: 0.859, percVolgend: 0.939 },
      { van: 80892, tot: 84693, percEerste: 0.837, percVolgend: 0.932 },
      { van: 84694, tot: 88491, percEerste: 0.812, percVolgend: 0.927 },
      { van: 88492, tot: 92291, percEerste: 0.789, percVolgend: 0.922 },
      { van: 92292, tot: 96091, percEerste: 0.767, percVolgend: 0.915 },
      { van: 96092, tot: 99889, percEerste: 0.743, percVolgend: 0.909 },
      { van: 99890, tot: 103694, percEerste: 0.721, percVolgend: 0.905 },
      { van: 103695, tot: 107492, percEerste: 0.696, percVolgend: 0.902 },
      { van: 107493, tot: 111290, percEerste: 0.673, percVolgend: 0.895 },
      { van: 111291, tot: 115090, percEerste: 0.651, percVolgend: 0.891 },
      { van: 115091, tot: 118963, percEerste: 0.627, percVolgend: 0.886 },
      { van: 118964, tot: 122857, percEerste: 0.606, percVolgend: 0.879 },
      { van: 122858, tot: 126747, percEerste: 0.585, percVolgend: 0.874 },
      { van: 126748, tot: 130638, percEerste: 0.564, percVolgend: 0.870 },
      { van: 130639, tot: 134527, percEerste: 0.542, percVolgend: 0.867 },
      { van: 134528, tot: 138420, percEerste: 0.523, percVolgend: 0.860 },
      { van: 138421, tot: 142312, percEerste: 0.504, percVolgend: 0.854 },
      { van: 142313, tot: 146205, percEerste: 0.485, percVolgend: 0.850 },
      { van: 146206, tot: 150092, percEerste: 0.465, percVolgend: 0.844 },
      { van: 150093, tot: 153982, percEerste: 0.445, percVolgend: 0.840 },
      { van: 153983, tot: 157877, percEerste: 0.425, percVolgend: 0.833 },
      { van: 157878, tot: 161766, percEerste: 0.405, percVolgend: 0.827 },
      { van: 161767, tot: 165657, percEerste: 0.385, percVolgend: 0.817 },
      { van: 165658, tot: 169547, percEerste: 0.365, percVolgend: 0.814 },
      { van: 169548, tot: 173440, percEerste: 0.365, percVolgend: 0.806 },
      { van: 173441, tot: 177335, percEerste: 0.365, percVolgend: 0.797 },
      { van: 177336, tot: 181223, percEerste: 0.365, percVolgend: 0.791 },
      { van: 181224, tot: 185114, percEerste: 0.365, percVolgend: 0.782 },
      { van: 185115, tot: 189002, percEerste: 0.365, percVolgend: 0.777 },
      { van: 189003, tot: 192896, percEerste: 0.365, percVolgend: 0.769 },
      { van: 192897, tot: 196789, percEerste: 0.365, percVolgend: 0.762 },
      { van: 196790, tot: 200681, percEerste: 0.365, percVolgend: 0.755 },
      { van: 200682, tot: 204571, percEerste: 0.365, percVolgend: 0.745 },
      { van: 204572, tot: 208458, percEerste: 0.365, percVolgend: 0.740 },
      { van: 208459, tot: 212353, percEerste: 0.365, percVolgend: 0.733 },
      { van: 212354, tot: 216242, percEerste: 0.365, percVolgend: 0.725 },
      { van: 216243, tot: 220134, percEerste: 0.365, percVolgend: 0.718 },
      { van: 220135, tot: 224026, percEerste: 0.365, percVolgend: 0.712 },
      { van: 224027, tot: 227915, percEerste: 0.365, percVolgend: 0.704 },
      { van: 227916, tot: 231807, percEerste: 0.365, percVolgend: 0.696 },
      { van: 231808, tot: 235697, percEerste: 0.365, percVolgend: 0.691 },
      { van: 235698, tot: Infinity, percEerste: 0.365, percVolgend: 0.682 }
    ];
    
   const calculateDutchTax2026 = (grossIncome, iack = 0) => {
      if (typeof grossIncome !== 'number' || grossIncome < 0) {
        throw new Error('grossIncome must be a non-negative number');
      }
      
      let tax = 0;
      let remaining = grossIncome;
      let previousLimit = 0;
      
      for (const bracket of TAX_BRACKETS_2026) {
        const bracketSize = Math.min(remaining, bracket.limit - previousLimit);
        if (bracketSize <= 0) break;
        
        tax += bracketSize * (bracket.rate / 100);
        remaining -= bracketSize;
        previousLimit = bracket.limit;
        
        if (remaining <= 0) break;
      }
      
      let algemene = TAX_CREDITS_2026.algemeneMax;
      if (grossIncome > TAX_CREDITS_2026.algemeneAfbouwStart) {
        const excess = grossIncome - TAX_CREDITS_2026.algemeneAfbouwStart;
        algemene -= excess * (TAX_CREDITS_2026.algemeneAfbouwPercentage / 100);
        algemene = Math.max(0, algemene);
      }
      
      let arbeid = 0;
      if (grossIncome <= TAX_CREDITS_2026.arbeidLowThreshold) {
        arbeid = grossIncome * (TAX_CREDITS_2026.arbeidBuildRateLow / 100);
      } else {
        arbeid = TAX_CREDITS_2026.arbeidMax;
        if (grossIncome > TAX_CREDITS_2026.arbeidPhaseoutStart) {
          const excess = grossIncome - TAX_CREDITS_2026.arbeidPhaseoutStart;
          arbeid -= excess * (TAX_CREDITS_2026.arbeidPhaseoutRate / 100);
          arbeid = Math.max(0, arbeid);
        }
      }
      
      const totalCredits = algemene + arbeid + iack;
      const netTax = Math.max(0, tax - totalCredits);
      const netIncome = grossIncome - netTax;
      
      return {
        grossIncome,
        incomeTax: Number(tax.toFixed(2)),
        credits: Number(totalCredits.toFixed(2)),
        iack: Number(iack.toFixed(2)),
        netTax: Number(netTax.toFixed(2)),
        netIncome: Number(netIncome.toFixed(2)),
        effectiveRate: grossIncome > 0 ? Number(((netTax / grossIncome) * 100).toFixed(2)) : 0
      };
    };
    
    // Bereken loonheffing (inhouding door werkgever, zonder rekening te houden met hypotheek/kortingen)
    const calculateLoonheffing = (grossIncome) => {
      // Loonheffing wordt berekend ZONDER hypotheekrenteaftrek
      // Werkgever kent geen hypotheek, dus houdt in alsof er geen aftrekposten zijn
      
      let tax = 0;
      let remaining = grossIncome;
      let previousLimit = 0;
      
      for (const bracket of TAX_BRACKETS_2026) {
        const bracketSize = Math.min(remaining, bracket.limit - previousLimit);
        if (bracketSize <= 0) break;
        
        tax += bracketSize * (bracket.rate / 100);
        remaining -= bracketSize;
        previousLimit = bracket.limit;
        
        if (remaining <= 0) break;
      }
      
      // Loonheffing = belasting - alleen AHK en AK (geen IACK, want werkgever kent je gezinssituatie niet)
      let algemene = TAX_CREDITS_2026.algemeneMax;
      if (grossIncome > TAX_CREDITS_2026.algemeneAfbouwStart) {
        const excess = grossIncome - TAX_CREDITS_2026.algemeneAfbouwStart;
        algemene -= excess * (TAX_CREDITS_2026.algemeneAfbouwPercentage / 100);
        algemene = Math.max(0, algemene);
      }
      
      let arbeid = 0;
      if (grossIncome <= TAX_CREDITS_2026.arbeidLowThreshold) {
        arbeid = grossIncome * (TAX_CREDITS_2026.arbeidBuildRateLow / 100);
      } else {
        arbeid = TAX_CREDITS_2026.arbeidMax;
        if (grossIncome > TAX_CREDITS_2026.arbeidPhaseoutStart) {
          const excess = grossIncome - TAX_CREDITS_2026.arbeidPhaseoutStart;
          arbeid -= excess * (TAX_CREDITS_2026.arbeidPhaseoutRate / 100);
          arbeid = Math.max(0, arbeid);
        }
      }
      
      const totalCredits = algemene + arbeid;
      return Math.max(0, tax - totalCredits);
    };
    
    // Bereken kindgebonden budget (netto toeslag)
    const berekenKindgebondenBudget = (toetsInkomen, aantalKinderen, fiscaalPartner, inflationFactor = 1) => {
      if (aantalKinderen === 0) return 0;
      
      const { KINDGEBONDEN_BUDGET } = TOESLAGEN_2026;
      const maxBedrag = KINDGEBONDEN_BUDGET.PER_KIND * aantalKinderen * inflationFactor;
      const drempel = fiscaalPartner ? KINDGEBONDEN_BUDGET.DREMPEL_PARTNER : KINDGEBONDEN_BUDGET.DREMPEL_ENKEL;
      
      if (toetsInkomen <= drempel) return maxBedrag;
      
      const vermindering = (toetsInkomen - drempel) * KINDGEBONDEN_BUDGET.AFBOUW_PERC;
      return Math.max(0, maxBedrag - vermindering);
    };
    
    // Bereken kinderopvangtoeslag (netto toeslag)
    const berekenKinderopvangtoeslag = (toetsInkomen, opvangDetails, inflationFactor = 1) => {
      if (!opvangDetails || opvangDetails.length === 0) return 0;
      
      const schijf = KINDEROPVANG_SCHIJVEN.find(s => 
        toetsInkomen >= s.van && toetsInkomen <= s.tot
      ) || KINDEROPVANG_SCHIJVEN[KINDEROPVANG_SCHIJVEN.length - 1];
      
      const { percEerste, percVolgend } = schijf;
      const { MAX_UREN_MAAND, TYPES } = TOESLAGEN_2026.KINDEROPVANG;
      
      let totaal = 0;
      const gesorteerd = [...opvangDetails].sort((a, b) => (b.uren || 0) - (a.uren || 0));
      
      gesorteerd.forEach((opv, index) => {
        const urenMaand = Math.min(opv.uren || 0, MAX_UREN_MAAND);
        const urenJaar = urenMaand * 12;
        const maxPrijs = TYPES[opv.type] || 0;
        const perc = (index === 0) ? percEerste : percVolgend;
        totaal += urenJaar * maxPrijs * perc * inflationFactor;
      });
      
      return Math.round(totaal);
    };
    
    // Bereken kinderbijslag (netto toeslag)
    const berekenKinderbijslag = (leeftijden, inflationFactor = 1) => {
      if (!leeftijden || leeftijden.length === 0) return 0;
      
      const { KINDERBIJSLAG } = TOESLAGEN_2026;
      let totaalJaar = 0;
      
      leeftijden.forEach((leeftijd) => {
        let config = null;
        
        if (leeftijd >= 0 && leeftijd <= 5) config = KINDERBIJSLAG.LEEFTIJD_0_5;
        else if (leeftijd >= 6 && leeftijd <= 11) config = KINDERBIJSLAG.LEEFTIJD_6_11;
        else if (leeftijd >= 12 && leeftijd <= 17) config = KINDERBIJSLAG.LEEFTIJD_12_17;
        
        if (config) {
          totaalJaar += config.kwartaal * 4 * inflationFactor;
        }
      });
      
      return totaalJaar;
    };
    
   // Bereken IACK (alleen voor minstverdienende met kind <12)
    const berekenIACK = (inkomstenWerkWoning) => {
      const inkomen = parseFloat(inkomstenWerkWoning) || 0;
      const { IACK } = TOESLAGEN_2026;
      
      // Formule: IF(inkomen<=6239; 0; IF(inkomen<=32710; 0,1145*(inkomen-6239); 3032))
      if (inkomen <= IACK.DREMPEL) return 0; // ‚Ç¨6.239
      if (inkomen <= 32710) {
        return IACK.FACTOR * (inkomen - IACK.DREMPEL); // 11,45%
      }
      return IACK.MAX; // ‚Ç¨3.032
    };
    
    // Centrale functie voor toetsinkomen berekening (voor toeslagen)
    const berekenToetsinkomen = (incomes, expenses, year, wozWaarde) => {
      // Toetsinkomen = verzamelinkomen = box 1 inkomen (na belasting en aftrek)
      // Dit is het inkomen dat de overheid gebruikt voor toeslagenberekening
      
      let partner1GrossIncome = 0;
      let partner2GrossIncome = 0;
      
      for (const income of incomes) {
        if (!isActiveInYear(income, year)) continue;
        if (['childcare', 'child-benefit', 'child-budget'].includes(income.category)) continue;
        
        const baseYearly = yearlyAmount(income.amount, income.frequency);
        const yearsActive = Math.max(0, year - income.startYear);
        const grown = grow(baseYearly, income.growthRate ?? 0, yearsActive);
        
        if (income.partner === 'partner2') {
          partner2GrossIncome += grown;
        } else {
          partner1GrossIncome += grown;
        }
      }
      
      const totalGrossIncome = partner1GrossIncome + partner2GrossIncome;
      const heeftPartner2 = partner2GrossIncome > 0;
      
      // Bereken hypotheekrente
      let hypotheekrenteAftrek = 0;
      for (const expense of expenses) {
        if (!isActiveInYear(expense, year)) continue;
        if (expense.category === 'housing' && expense.mortgageType) {
          const yearsActive = Math.max(0, year - expense.startYear);
          const mortgageData = calculateMortgageYear({
            outstandingAmount: expense.outstandingAmount,
            interestRate: expense.interestRate,
            remainingMonths: expense.remainingMonths,
            mortgageType: expense.mortgageType
          }, yearsActive);
          hypotheekrenteAftrek += mortgageData.interest;
        }
      }
      
      // EWF
      const ewf = berekenEigenwoningforfait(wozWaarde || 0);
      
      // Optimale verdeling
      let hypotheekrenteAftrekPartner1 = 0;
      let hypotheekrenteAftrekPartner2 = 0;
      let ewfPartner1 = 0;
      let ewfPartner2 = 0;
      
      if (heeftPartner2) {
        if (partner1GrossIncome >= partner2GrossIncome) {
          hypotheekrenteAftrekPartner1 = hypotheekrenteAftrek;
          ewfPartner1 = ewf;
        } else {
          hypotheekrenteAftrekPartner2 = hypotheekrenteAftrek;
          ewfPartner2 = ewf;
        }
      } else {
        hypotheekrenteAftrekPartner1 = hypotheekrenteAftrek;
        ewfPartner1 = ewf;
      }
      
      // Bereken belasting per partner (simpel, zonder IACK want die komt later)
      let netIncome1 = 0;
      if (partner1GrossIncome > 0) {
        const taxableIncome1 = Math.max(0, partner1GrossIncome - hypotheekrenteAftrekPartner1 + ewfPartner1);
        const taxResult1 = calculateDutchTax2026(taxableIncome1, 0);
        netIncome1 = partner1GrossIncome - taxResult1.netTax;
      }
      
      let netIncome2 = 0;
      if (partner2GrossIncome > 0) {
        const taxableIncome2 = Math.max(0, partner2GrossIncome - hypotheekrenteAftrekPartner2 + ewfPartner2);
        const taxResult2 = calculateDutchTax2026(taxableIncome2, 0);
        netIncome2 = partner2GrossIncome - taxResult2.netTax;
      }
      
      // Toetsinkomen = verzamelinkomen = box 1 (bruto - aftrek + EWF) + box 3 fictief rendement
// Box 1: bruto - hypotheekrente + EWF (NIET na belasting!)
const box1Income1 = partner1GrossIncome > 0 
  ? partner1GrossIncome - hypotheekrenteAftrekPartner1 + ewfPartner1 
  : 0;
  
const box1Income2 = partner2GrossIncome > 0 
  ? partner2GrossIncome - hypotheekrenteAftrekPartner2 + ewfPartner2 
  : 0;

const totalBox1 = box1Income1 + box1Income2;

// TODO: Box 3 fictief rendement toevoegen wanneer vermogen > vrijstelling
// Voor nu: verzamelinkomen ‚âà box 1 inkomen
return totalBox1;
    };
    
    // Eigenwoningforfait berekening (2026)
    const berekenEigenwoningforfait = (wozWaarde) => {
      const woz = parseFloat(wozWaarde) || 0;
      
      if (woz <= 75000) return 0;
      if (woz <= 1350000) return woz * 0.0035;
      
      return 4725 + (woz - 1350000) * 0.0235;
    };
    
    // Calculate verzamelinkomen (for toeslagen calculation)
    const berekenVerzamelinkomen = (incomes, expenses, year, wozWaarde) => {
      // Calculate gross income
      let totalGrossIncome = 0;
      
      for (const income of incomes) {
        if (!isActiveInYear(income, year)) continue;
        const baseYearly = yearlyAmount(income.amount, income.frequency);
        const yearsActive = Math.max(0, year - income.startYear);
        const grown = grow(baseYearly, income.growthRate ?? 0, yearsActive);
        totalGrossIncome += grown;
      }
      
      // Calculate hypotheekrente
      let hypotheekrente = 0;
      for (const expense of expenses) {
        if (!isActiveInYear(expense, year)) continue;
        if (expense.category === 'housing' && expense.mortgageType) {
          const yearsActive = Math.max(0, year - expense.startYear);
          const mortgageData = calculateMortgageYear({
            outstandingAmount: expense.outstandingAmount,
            interestRate: expense.interestRate,
            remainingMonths: expense.remainingMonths,
            mortgageType: expense.mortgageType
          }, yearsActive);
          hypotheekrente += mortgageData.interest;
        }
      }
      
      // Calculate eigenwoningforfait
      const ewf = berekenEigenwoningforfait(wozWaarde);
      
      // Box 1 inkomen = bruto - hypotheekrente - AO + EWF
      // (We don't have AO in the current system, so we skip it)
      const box1Inkomen = totalGrossIncome - hypotheekrente + ewf;
      
      // For now, verzamelinkomen = box1Inkomen (Box 3 rendement is typically small)
      // In future we can add Box 3 if needed
      return box1Inkomen;
    };
    
    // Mortgage Calculation with Amortization
    const calculateMortgageYear = ({ outstandingAmount, interestRate, remainingMonths, mortgageType }, yearsSinceStart) => {
      const monthlyRate = (interestRate / 100) / 12;
      
      // Interest-only (aflossingsvrij) mortgage: balance stays the same
      if (mortgageType === 'interest-only') {
        const annualInterest = outstandingAmount * (interestRate / 100);
        return {
          payment: annualInterest,
          interest: annualInterest,
          principal: 0,
          remainingBalance: outstandingAmount // Balance never changes
        };
      }
      
      // Interest-free mortgage (0% rate): simple amortization
      if (!monthlyRate) {
        const monthlyPayment = outstandingAmount / remainingMonths;
        const yearsElapsed = Math.min(yearsSinceStart, Math.floor(remainingMonths / 12));
        return {
          payment: monthlyPayment * 12,
          interest: 0,
          principal: monthlyPayment * 12,
          remainingBalance: Math.max(0, outstandingAmount - (monthlyPayment * 12 * yearsElapsed))
        };
      }
      
      // Annuity calculation
      // NOTE: outstandingAmount is the CURRENT balance (not original principal)
      // So for yearsSinceStart = 0, we return current balance
      // For yearsSinceStart > 0, we calculate forward from current balance
      
      const monthlyPayment = outstandingAmount * (monthlyRate / (1 - Math.pow(1 + monthlyRate, -remainingMonths)));
      
      if (yearsSinceStart === 0) {
        // Return current state (no time elapsed)
        return {
          payment: monthlyPayment * 12,
          interest: outstandingAmount * (interestRate / 100),
          principal: (monthlyPayment * 12) - (outstandingAmount * (interestRate / 100)),
          remainingBalance: outstandingAmount
        };
      }
      
      // Calculate balance after yearsSinceStart years from current balance
      let balance = outstandingAmount;
      let totalInterestThisYear = 0;
      
      const monthsPassed = yearsSinceStart * 12;
      const startMonth = Math.max(0, monthsPassed - 12);
      const endMonth = Math.min(monthsPassed, remainingMonths);
      
      // Fast forward to start of this year
      for (let month = 0; month < startMonth; month++) {
        const interest = balance * monthlyRate;
        const principal = monthlyPayment - interest;
        balance -= principal;
      }
      
      // Calculate this year's interest
      for (let month = startMonth; month < endMonth; month++) {
        const interest = balance * monthlyRate;
        const principal = monthlyPayment - interest;
        totalInterestThisYear += interest;
        balance -= principal;
      }
      
      return {
        payment: monthlyPayment * 12,
        interest: totalInterestThisYear,
        principal: (monthlyPayment * 12) - totalInterestThisYear,
        remainingBalance: Math.max(0, balance)
      };
    };
    
    const mortgagePaymentAnnual = ({ outstandingAmount, interestRate, remainingMonths, mortgageType }) => {
      return calculateMortgageYear({ outstandingAmount, interestRate, remainingMonths, mortgageType }, 1).payment;
    };
    
   // From cashflow.js
    const calculateAnnualCashflow = (year, incomes, expenses, assumptions = {}) => {
      if (typeof year !== 'number' || year < 1900) {
        throw new Error('Invalid year');
      }
      
      const inflationRate = assumptions.inflationRate ?? 0;
      
      // Bereken inkomen per partner
      let partner1GrossIncome = 0;
      let partner2GrossIncome = 0;
      let toeslagenIncome = 0; // Toeslagen zijn niet belastbaar
      
      for (const income of incomes) {
        if (!isActiveInYear(income, year)) continue;
        
        // Toeslagen tellen niet mee voor belastingberekening
        if (['childcare', 'child-benefit', 'child-budget'].includes(income.category)) {
          continue; // Skip, wordt later berekend
        }
        
        const baseYearly = yearlyAmount(income.amount, income.frequency);
        const yearsActive = Math.max(0, year - income.startYear);
        const grown = grow(baseYearly, income.growthRate ?? 0, yearsActive);
        
        // Verdeel inkomen per partner
        if (income.partner === 'partner2') {
          partner2GrossIncome += grown;
        } else {
          partner1GrossIncome += grown; // Default = partner1
        }
      }
      
      const totalGrossIncome = partner1GrossIncome + partner2GrossIncome;
      const heeftPartner2 = partner2GrossIncome > 0;
      
      // Track mortgage interest for tax deduction
      let hypotheekrenteAftrek = 0;
      let totalExpenses = 0;
      
      for (const expense of expenses) {
        if (!isActiveInYear(expense, year)) continue;
        
        // Handle mortgage with amortization and interest deduction
        if (expense.category === 'housing' && expense.mortgageType) {
          const yearsActive = Math.max(0, year - expense.startYear);
          const mortgageData = calculateMortgageYear({
            outstandingAmount: expense.outstandingAmount,
            interestRate: expense.interestRate,
            remainingMonths: expense.remainingMonths,
            mortgageType: expense.mortgageType
          }, yearsActive);
          
          totalExpenses += mortgageData.payment;
          hypotheekrenteAftrek += mortgageData.interest;
          continue;
        }
        
        const baseYearly = yearlyAmount(expense.amount, expense.frequency);
        const yearsActive = Math.max(0, year - expense.startYear);
        
        const adjusted = expense.adjustForInflation
          ? grow(baseYearly, inflationRate, yearsActive)
          : baseYearly;
        
        totalExpenses += adjusted;
      }
      
     // Bereken EWF
      const ewf = berekenEigenwoningforfait(assumptions.wozWaarde || 0);
      
      // OPTIMALE VERDELING: hypotheekrenteaftrek en EWF naar hoogste inkomen voor maximaal fiscaal voordeel
      // Hoogste inkomen zit in hogere belastingschijf ‚Üí meer aftrek waard
      let hypotheekrenteAftrekPartner1 = 0;
      let hypotheekrenteAftrekPartner2 = 0;
      let ewfPartner1 = 0;
      let ewfPartner2 = 0;
      
      if (heeftPartner2) {
        // Geef ALLE aftrekposten aan hoogste inkomen
        if (partner1GrossIncome >= partner2GrossIncome) {
          hypotheekrenteAftrekPartner1 = hypotheekrenteAftrek;
          ewfPartner1 = ewf;
        } else {
          hypotheekrenteAftrekPartner2 = hypotheekrenteAftrek;
          ewfPartner2 = ewf;
        }
      } else {
        hypotheekrenteAftrekPartner1 = hypotheekrenteAftrek;
        ewfPartner1 = ewf;
      }
      
      // Calculate IACK (gaat naar laagste inkomen)
      let iack = 0;
      const heeftKindOnder12 = incomes.some(inc => 
        inc.category === 'child-benefit' && 
        inc.metadata?.kinderenLeeftijden?.some(leeftijd => leeftijd < 12)
      );
      
      if (heeftKindOnder12 && totalGrossIncome > 0) {
        // IACK berekenen voor laagste inkomen
        let laagsteInkomen = partner1GrossIncome;
        let laagsteInkomenEWF = ewfPartner1;
        let laagsteInkomenHypotheekAftrek = hypotheekrenteAftrekPartner1;
        
        if (heeftPartner2 && partner2GrossIncome < partner1GrossIncome) {
          laagsteInkomen = partner2GrossIncome;
          laagsteInkomenEWF = ewfPartner2;
          laagsteInkomenHypotheekAftrek = hypotheekrenteAftrekPartner2;
        }
        
        // IACK = inkomsten werk en woning van laagste inkomen
        const inkomstenWerkWoning = laagsteInkomen + laagsteInkomenEWF - laagsteInkomenHypotheekAftrek;
        iack = berekenIACK(inkomstenWerkWoning);
      }
      
      // Bereken belasting per partner
      let loonheffing1 = 0;
      let werkelijkeBelasting1 = 0;
      let teruggaafIB1 = 0;
      
      if (partner1GrossIncome > 0) {
        loonheffing1 = calculateLoonheffing(partner1GrossIncome);
        const taxableIncome1 = Math.max(0, partner1GrossIncome - hypotheekrenteAftrekPartner1);
        
        // IACK gaat naar laagste inkomen
        const iackPartner1 = (!heeftPartner2 || partner1GrossIncome <= partner2GrossIncome) ? iack : 0;
        const taxResult1 = calculateDutchTax2026(taxableIncome1, iackPartner1);
        
        werkelijkeBelasting1 = taxResult1.netTax;
        teruggaafIB1 = loonheffing1 - werkelijkeBelasting1;
      }
      
      let loonheffing2 = 0;
      let werkelijkeBelasting2 = 0;
      let teruggaafIB2 = 0;
      
      if (partner2GrossIncome > 0) {
        loonheffing2 = calculateLoonheffing(partner2GrossIncome);
        const taxableIncome2 = Math.max(0, partner2GrossIncome - hypotheekrenteAftrekPartner2);
        
        // IACK gaat naar laagste inkomen
        const iackPartner2 = (partner2GrossIncome < partner1GrossIncome) ? iack : 0;
        const taxResult2 = calculateDutchTax2026(taxableIncome2, iackPartner2);
        
        werkelijkeBelasting2 = taxResult2.netTax;
        teruggaafIB2 = loonheffing2 - werkelijkeBelasting2;
      }
      
      // Totalen
      const totalLoonheffing = loonheffing1 + loonheffing2;
      const totalWerkelijkeBelasting = werkelijkeBelasting1 + werkelijkeBelasting2;
      const totalTeruggaafIB = teruggaafIB1 + teruggaafIB2;
      const netIncome = totalGrossIncome - totalWerkelijkeBelasting;
      
      // Bereken toeslagen (netto, niet belastbaar)
      let toeslagenTotaal = 0;
      
      // Toetsinkomen voor toeslagen = gezamenlijk netto inkomen
      const toetsInkomen = netIncome;
      
      for (const income of incomes) {
        if (!isActiveInYear(income, year)) continue;
        
        // Calculate inflation factor for toeslagen (delayed by 1 year)
        const yearsActive = Math.max(0, year - income.startYear);
        const inflationYears = Math.max(0, yearsActive - 1);
        const inflationFactor = Math.pow(1 + inflationRate / 100, inflationYears);
        
        // Kinderopvangtoeslag
        if (income.category === 'childcare' && income.metadata?.kinderen) {
          toeslagenTotaal += berekenKinderopvangtoeslag(toetsInkomen, income.metadata.kinderen, inflationFactor);
        }
        
        // Kinderbijslag
        if (income.category === 'child-benefit' && income.metadata?.kinderenLeeftijden) {
          toeslagenTotaal += berekenKinderbijslag(income.metadata.kinderenLeeftijden, inflationFactor);
        }
        
        // Kindgebonden budget
        if (income.category === 'child-budget' && income.metadata?.aantalKinderen) {
          toeslagenTotaal += berekenKindgebondenBudget(
            toetsInkomen, 
            income.metadata.aantalKinderen, 
            heeftPartner2, // fiscaalPartner = heeft partner 2
            inflationFactor
          );
        }
      }
      
      // Correct savings calculation: add toeslagen to available income
      const totalAvailable = netIncome + toeslagenTotaal;
      const netSavings = totalAvailable - totalExpenses;
      
      // Bereken effectief belastingtarief
      const effectiveTaxRate = totalGrossIncome > 0 
        ? Number((totalWerkelijkeBelasting / totalGrossIncome * 100).toFixed(2)) 
        : 0;
      
      return {
        year: Number(year),
        grossIncome: Number(totalGrossIncome.toFixed(2)),
        partner1GrossIncome: Number(partner1GrossIncome.toFixed(2)),
        partner2GrossIncome: Number(partner2GrossIncome.toFixed(2)),
        taxableIncome: Number((totalGrossIncome - hypotheekrenteAftrek).toFixed(2)),
        loonheffing: Number(totalLoonheffing.toFixed(2)),
        werkelijkeBelasting: Number(totalWerkelijkeBelasting.toFixed(2)),
        teruggaafIB: Number(totalTeruggaafIB.toFixed(2)),
        iack: Number(iack.toFixed(2)),
        netIncome: Number(netIncome.toFixed(2)),
        expenses: Number(totalExpenses.toFixed(2)),
        savings: Number(netSavings.toFixed(2)),
        toeslagen: Number(toeslagenTotaal.toFixed(2)),
        hypotheekrenteAftrek: Number(hypotheekrenteAftrek.toFixed(2)),
        effectiveTaxRate: effectiveTaxRate
      };
    };
    
    // From kpis.js
    const projectNetWorth = ({
      startYear,
      endYear,
      startNetWorth = 0,
      incomes = [],
      expenses = [],
      assumptions = {},
      assets = [],
      liabilities = []
    }) => {
      if (startYear > endYear) {
        throw new Error('startYear must be <= endYear');
      }
      if (typeof startNetWorth !== 'number' || startNetWorth < 0) {
        throw new Error('startNetWorth must be a non-negative number');
      }
      
      const investmentRate = (assumptions.investmentReturn ?? 0) / 100;
      
      let liquidNetWorth = startNetWorth; // Cash/investments that grow with investment return
      const timeline = [];
      
      for (let year = startYear; year <= endYear; year++) {
        const cashflow = calculateAnnualCashflow(year, incomes, expenses, { ...assumptions, wozWaarde: assumptions.wozWaarde || 0 });
        
        // Liquid net worth grows with investment return + savings
        liquidNetWorth *= (1 + investmentRate);
        liquidNetWorth += cashflow.savings; // Toeslagen already included in savings
        liquidNetWorth = Number(liquidNetWorth.toFixed(2));
        
        // Calculate assets, liabilities and equity
        const totalAssets = calculateAssetsValue(assets, year);
        const liabilitiesData = calculateLiabilitiesValue(liabilities, expenses, year);
        const totalLiabilities = liabilitiesData.totalLiabilities;
        const mortgageLiability = liabilitiesData.mortgageLiability;
        const equity = calculateEquity(assets, expenses, year); // Property - Mortgage only
        
        // Calculate non-mortgage liabilities separately
        const otherLiabilities = totalLiabilities - mortgageLiability;
        
        // Total net worth = liquid net worth + equity + other assets - other liabilities
        const totalNetWorth = liquidNetWorth + equity + (totalAssets - calculatePropertyValue(assets, year)) - otherLiabilities;
        
        timeline.push({
          year,
          netWorth: totalNetWorth,
          liquidNetWorth,
          totalAssets,
          totalLiabilities,
          mortgageLiability,
          otherLiabilities,
          equity, // Property - Mortgage only
          cashflow,
          savingsRate: cashflow.netIncome > 0
            ? Number((cashflow.savings / cashflow.netIncome * 100).toFixed(2))
            : null
        });
      }
      
      return timeline;
    };
    
    const findFireYear = (timeline, targetNetWorth) => {
      if (!Array.isArray(timeline) || typeof targetNetWorth !== 'number') return null;
      
      const hit = timeline.find(entry => entry.netWorth >= targetNetWorth);
      return hit ? hit.year : null;
    };
    
    const monthlySavingsFromCashflow = (cashflow) => {
      if (!cashflow || typeof cashflow.savings !== 'number') return 0;
      return Number((cashflow.savings / 12).toFixed(2));
    };
    
    // Calculate total assets value for a given year
    const calculateAssetsValue = (assets, year) => {
      let totalAssets = 0;
      
      assets.forEach(asset => {
        if (year >= asset.startYear) {
          const yearsActive = year - asset.startYear;
          const currentValue = grow(asset.value, asset.growthRate || 0, yearsActive);
          totalAssets += currentValue;
        }
      });
      
      return totalAssets;
    };
    
    // Calculate only property assets value for a given year
    const calculatePropertyValue = (assets, year) => {
      let propertyValue = 0;
      
      assets.forEach(asset => {
        if (asset.type === 'property' && year >= asset.startYear) {
          const yearsActive = year - asset.startYear;
          const currentValue = grow(asset.value, asset.growthRate || 0, yearsActive);
          propertyValue += currentValue;
        }
      });
      
      return propertyValue;
    };
    
    // Calculate total liabilities for a given year
    const calculateLiabilitiesValue = (liabilities, expenses, year) => {
      let totalLiabilities = 0;
      let mortgageLiability = 0;
      
      // Add mortgage from expenses (housing category)
      expenses.forEach(expense => {
        if (expense.category === 'housing' && expense.mortgageType && isActiveInYear(expense, year)) {
          const yearsActive = Math.max(0, year - expense.startYear);
          const mortgageData = calculateMortgageYear({
            outstandingAmount: expense.outstandingAmount,
            interestRate: expense.interestRate,
            remainingMonths: expense.remainingMonths,
            mortgageType: expense.mortgageType
          }, yearsActive); // Balance at START of this year
          mortgageLiability += mortgageData.remainingBalance;
          totalLiabilities += mortgageData.remainingBalance;
        }
      });
      
      // Add other liabilities (for now, assume they stay constant)
      liabilities.forEach(liability => {
        if (year >= liability.startYear) {
          totalLiabilities += liability.amount;
        }
      });
      
      return { totalLiabilities, mortgageLiability };
    };
    
    // Calculate equity (ONLY property value - mortgage)
    const calculateEquity = (assets, expenses, year) => {
      // Find property assets
      let propertyValue = 0;
      assets.forEach(asset => {
        if (asset.type === 'property' && year >= asset.startYear) {
          const yearsActive = year - asset.startYear;
          const currentValue = grow(asset.value, asset.growthRate || 0, yearsActive);
          propertyValue += currentValue;
        }
      });
      
      // Get mortgage liability
      let mortgageLiability = 0;
      expenses.forEach(expense => {
        if (expense.category === 'housing' && expense.mortgageType && isActiveInYear(expense, year)) {
          const yearsActive = Math.max(0, year - expense.startYear);
          const mortgageData = calculateMortgageYear({
            outstandingAmount: expense.outstandingAmount,
            interestRate: expense.interestRate,
            remainingMonths: expense.remainingMonths,
            mortgageType: expense.mortgageType
          }, yearsActive); // Balance at START of this year (before payments)
          mortgageLiability += mortgageData.remainingBalance;
        }
      });
      
      // Equity = Property value - Mortgage
      return propertyValue - mortgageLiability;
    };
    
    // ============================================
    // UI COMPONENTS
    // ============================================
    
    const formatCurrency = (value) => {
      return new Intl.NumberFormat('nl-NL', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      }).format(value);
    };
    
    // Calculate actual toeslag amount for display based on current data
    const calculateToeslagAmount = (item, incomes, expenses, year, wozWaarde) => {
      const toetsinkomen = berekenToetsinkomen(incomes, expenses, year, wozWaarde);
      
      if (item.category === 'childcare' && item.metadata?.kinderen) {
        return berekenKinderopvangtoeslag(toetsinkomen, item.metadata.kinderen);
      }
      
      if (item.category === 'child-benefit' && item.metadata?.kinderenLeeftijden) {
        return berekenKinderbijslag(item.metadata.kinderenLeeftijden);
      }
      
      if (item.category === 'child-budget' && item.metadata?.aantalKinderen) {
        // Check of er partner 2 is
        const heeftPartner2 = incomes.some(inc => inc.partner === 'partner2');
        return berekenKindgebondenBudget(
          toetsinkomen,
          item.metadata.aantalKinderen,
          heeftPartner2
        );
      }
      
      if (item.category === 'child-benefit' && item.metadata?.kinderenLeeftijden) {
        return berekenKinderbijslag(item.metadata.kinderenLeeftijden);
      }
      
      if (item.category === 'child-budget' && item.metadata?.aantalKinderen) {
        return berekenKindgebondenBudget(
          verzamelinkomen,
          item.metadata.aantalKinderen,
          item.metadata.fiscaalPartner || false
        );
      }
      
      return 0;
    };

    function ItemList({ items, type, onEdit, onDelete, incomes, expenses, wozWaarde }) {
      if (items.length === 0) {
        return (
          <div className="text-sm text-gray-400 italic py-2">
            Nog geen items toegevoegd
          </div>
        );
      }
      
      const categoryEmoji = {
        // Expense categories
        housing: 'üè†',
        recurring: 'üîÑ',
        children: 'üë∂',
        other: 'üõí',
        // Income categories
        salary: 'üíº',
        childcare: 'üë∂',
        'child-benefit': 'üçº',
        'child-budget': 'üë®‚Äçüë©‚Äçüëß',
        'other-income': 'üí∞'
      };
      
      return (
        <div className="space-y-2">
          {items.map(item => (
            <div 
              key={item.id}
              className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
            >
              <div className="flex-1 cursor-pointer" onClick={() => onEdit(type, item)}>
                <div className="font-medium text-sm flex items-center gap-1">
                  {item.category && categoryEmoji[item.category]}
                  {item.name}
                  {item.category === 'childcare' && item.metadata?.kinderen?.length > 0 && (
                    <span className="text-xs text-gray-500 ml-1">
                      ({item.metadata.kinderen.length} {item.metadata.kinderen.length === 1 ? 'kind' : 'kinderen'})
                    </span>
                  )}
                  {item.category === 'child-benefit' && item.metadata?.kinderenLeeftijden?.length > 0 && (
                    <span className="text-xs text-gray-500 ml-1">
                      ({item.metadata.kinderenLeeftijden.length} {item.metadata.kinderenLeeftijden.length === 1 ? 'kind' : 'kinderen'})
                    </span>
                  )}
                  {item.category === 'child-budget' && item.metadata?.aantalKinderen > 0 && (
                    <span className="text-xs text-gray-500 ml-1">
                      ({item.metadata.aantalKinderen} {item.metadata.aantalKinderen === 1 ? 'kind' : 'kinderen'})
                    </span>
                  )}
                </div>
               <div className="text-xs text-gray-600">
                  {['childcare', 'child-benefit', 'child-budget'].includes(item.category) ? (
                    <>
                      <span className="font-semibold text-primary">
                        {formatCurrency(calculateToeslagAmount(item, incomes || [], expenses || [], new Date().getFullYear(), wozWaarde || 0))} / jaar
                      </span>
                    </>
                  ) : (
                    <>
                      {formatCurrency(item.amount)} / {item.frequency === 'monthly' ? 'maand' : 'jaar'}
                      {type === 'income' && item.growthRate > 0 && ` ‚Ä¢ ${item.growthRate}% groei`}
                      {type === 'income' && item.partner === 'partner2' && ` ‚Ä¢ Partner 2`}
                    </>
                  )}
                </div>
                <div className="text-xs text-gray-500">
                  {item.endYear ? `${item.startYear} - ${item.endYear}` : `Vanaf ${item.startYear}`}
                </div>
              </div>
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  onDelete(type, item.id);
                }}
                className="ml-2 text-red-500 hover:text-red-700 text-sm"
              >
                üóëÔ∏è
              </button>
            </div>
          ))}
        </div>
      );
    }

    function EditDialog({ isOpen, type, item, onSave, onCancel }) {
      const [formData, setFormData] = useState(item || {});
      
      useEffect(() => {
        setFormData(item || {});
      }, [item]);
      
      if (!isOpen) return null;
      
      const handleSubmit = (e) => {
        e.preventDefault();
        onSave(formData);
      };
      
      const updateField = (field, value) => {
        setFormData({ ...formData, [field]: value });
      };
      
      const getTaxBreakdown = () => {
        if (type !== 'income') return null;
        const yearly = yearlyAmount(formData.amount || 0, formData.frequency || 'yearly');
        
        let remaining = yearly;
        let previousLimit = 0;
        const breakdown = [];
        
        for (const bracket of TAX_BRACKETS_2026) {
          const bracketSize = Math.min(remaining, bracket.limit - previousLimit);
          if (bracketSize <= 0) break;
          
          breakdown.push({
            from: previousLimit,
            to: bracket.limit === Infinity ? '‚àû' : bracket.limit,
            rate: bracket.rate,
            amount: bracketSize,
          });
          
          remaining -= bracketSize;
          previousLimit = bracket.limit;
          
          if (remaining <= 0) break;
        }
        
        return breakdown;
      };
      
      const getEffectiveTaxRate = () => {
        if (type !== 'income') return 0;
        const yearly = yearlyAmount(formData.amount || 0, formData.frequency || 'yearly');
        const taxResult = calculateDutchTax2026(yearly);
        return taxResult.effectiveRate;
      };
      
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <form onSubmit={handleSubmit}>
              <div className="p-6 border-b">
                <h2 className="text-xl font-bold text-dark">
                  {type === 'income' ? 'üí∞ Inkomen bewerken' : 'üõí Uitgave bewerken'}
                </h2>
              </div>
              
              <div className="p-6 space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Naam</label>
                  <input
                    type="text"
                    value={formData.name || ''}
                    onChange={(e) => updateField('name', e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                    required
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Start</label>
                  <input
                    type="number"
                    value={formData.startYear || new Date().getFullYear()}
                    onChange={(e) => updateField('startYear', parseInt(e.target.value) || new Date().getFullYear())}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                    required
                    min="2000"
                    max={new Date().getFullYear() + 70}
                  />
                </div>
                
               <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Einde</label>
                  <select
                    value={formData.endYear || ''}
                    onChange={(e) => updateField('endYear', e.target.value ? parseInt(e.target.value) : null)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                  >
                    <option value="">Doorlopend</option>
                    {Array.from({ length: 50 }, (_, i) => new Date().getFullYear() + i).map(year => (
                      <option key={year} value={year}>{year}</option>
                    ))}
                  </select>
                </div>
                
                {type === 'income' && !['childcare', 'child-benefit', 'child-budget'].includes(formData.category) && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Van wie is dit inkomen?</label>
                    <select
                      value={formData.partner || 'partner1'}
                      onChange={(e) => updateField('partner', e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                    >
                      <option value="partner1">Partner 1</option>
                      <option value="partner2">Partner 2</option>
                    </select>
                    <p className="text-xs text-gray-500 mt-1">Voor correcte belastingberekening bij fiscaal partnerschap</p>
                  </div>
                )}
                
                <div className="pt-2">
                  <h3 className="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">Details</h3>
                </div>
                
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Bedrag {type === 'income' ? '(bruto)' : ''}
                    </label>
                    {['childcare', 'child-benefit', 'child-budget'].includes(formData.category) ? (
                      <div className="bg-gray-100 px-4 py-3 rounded-lg border border-gray-300">
                        <p className="text-sm text-gray-600 italic">
                          Wordt automatisch berekend op basis van verzamelinkomen en ingevoerde details
                        </p>
                      </div>
                    ) : (
                      <div className="flex items-center border border-gray-300 rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-primary focus-within:border-transparent">
                        <span className="px-3 py-2 text-gray-500 bg-gray-50 border-r">‚Ç¨</span>
                        <input
                          type="number"
                          value={formData.amount || 0}
                          onChange={(e) => updateField('amount', parseFloat(e.target.value) || 0)}
                          className="flex-1 px-3 py-2 border-0 focus:ring-0"
                          required
                          min="0"
                          step="0.01"
                        />
                      </div>
                    )}
                  </div>
                  
                  {!['childcare', 'child-benefit', 'child-budget'].includes(formData.category) && (
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Frequentie</label>
                      <select
                        value={formData.frequency || 'yearly'}
                        onChange={(e) => updateField('frequency', e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                      >
                        <option value="yearly">Per jaar</option>
                        <option value="monthly">Per maand</option>
                      </select>
                    </div>
                  )}
                </div>
                
                {type === 'expense' && formData.category !== 'housing' && (
                  <div className="flex items-center gap-2 pt-2">
                    <input
                      type="checkbox"
                      id="adjustInflation"
                      checked={formData.adjustForInflation || false}
                      onChange={(e) => updateField('adjustForInflation', e.target.checked)}
                      className="w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary"
                    />
                    <label htmlFor="adjustInflation" className="text-sm text-gray-700">
                      Pas aan voor inflatie in de tijd
                    </label>
                  </div>
                )}
                
                {type === 'income' && !['childcare', 'child-benefit', 'child-budget'].includes(formData.category) && (
                  <>
                    <div>
                      <div className="flex items-center justify-between mb-2">
                        <label className="text-sm font-medium text-gray-700">
                          Belastingtarief (schijven 2026)
                        </label>
                      </div>
                      
                      <div className="border border-gray-300 rounded-lg p-4 bg-gray-50 space-y-3">
                        <div className="text-xs text-gray-600 mb-2">
                          Nederlandse belastingschijven inclusief heffingskortingen
                        </div>
                        
                        {getTaxBreakdown()?.map((bracket, index) => (
                          <div key={index} className="grid grid-cols-2 gap-2 text-sm">
                            <div className="text-gray-600">
                              Tot {bracket.to === '‚àû' ? '‚àû' : formatCurrency(bracket.to)}
                            </div>
                            <div className="text-gray-900 font-medium">
                              {bracket.rate.toFixed(2)}%
                            </div>
                          </div>
                        ))}
                        
                        <div className="pt-2 border-t">
                          <div className="text-xs text-gray-600 font-medium mb-1">
                            Effectief tarief (na kortingen):
                          </div>
                          <div className="text-sm font-bold text-primary">
                            {getEffectiveTaxRate().toFixed(2)}%
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div>
                      <label className="text-sm font-medium text-gray-700 mb-1 block">
                        Groeipercentage (% p.j.)
                      </label>
                      <div className="flex items-center border border-gray-300 rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-primary focus-within:border-transparent">
                        <input
                          type="number"
                          value={formData.growthRate || 0}
                          onChange={(e) => updateField('growthRate', parseFloat(e.target.value) || 0)}
                          className="flex-1 px-3 py-2 border-0 focus:ring-0"
                          min="0"
                          max="100"
                          step="0.1"
                        />
                        <span className="px-3 py-2 text-gray-500 bg-gray-100 border-l">%</span>
                      </div>
                    </div>
                  </>
                )}
                
                {type === 'income' && formData.category === 'childcare' && (
                  <div className="bg-teal-50 p-4 rounded-lg space-y-3">
                    <h4 className="font-semibold text-gray-800">Kinderopvang details</h4>
                    <p className="text-xs text-gray-600">Voeg kinderen toe met uren per maand en type opvang</p>
                    
                    <button
                      type="button"
                      onClick={() => {
                        const kinderen = formData.metadata?.kinderen || [];
                        updateField('metadata', {
                          ...formData.metadata,
                          kinderen: [...kinderen, { uren: 0, type: 'dagopvang' }]
                        });
                      }}
                      className="text-sm bg-teal-600 text-white px-3 py-1 rounded hover:bg-teal-700"
                    >
                      + Voeg kind toe
                    </button>
                    
                    {(formData.metadata?.kinderen || []).map((kind, index) => (
                      <div key={index} className="bg-white p-3 rounded space-y-2">
                        <div className="flex items-center justify-between">
                          <span className="text-sm font-medium">Kind {index + 1}</span>
                          <button
                            type="button"
                            onClick={() => {
                              const kinderen = [...(formData.metadata?.kinderen || [])];
                              kinderen.splice(index, 1);
                              updateField('metadata', { ...formData.metadata, kinderen });
                            }}
                            className="text-red-500 text-xs hover:text-red-700"
                          >
                            Verwijder
                          </button>
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                          <div>
                            <label className="block text-xs text-gray-600 mb-1">Uren/maand (max 230)</label>
                            <input
                              type="number"
                              min="0"
                              max="230"
                              value={kind.uren}
                              onChange={(e) => {
                                const kinderen = [...(formData.metadata?.kinderen || [])];
                                kinderen[index] = { ...kinderen[index], uren: parseInt(e.target.value) || 0 };
                                updateField('metadata', { ...formData.metadata, kinderen });
                              }}
                              className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                            />
                          </div>
                          <div>
                            <label className="block text-xs text-gray-600 mb-1">Type opvang</label>
                            <select
                              value={kind.type}
                              onChange={(e) => {
                                const kinderen = [...(formData.metadata?.kinderen || [])];
                                kinderen[index] = { ...kinderen[index], type: e.target.value };
                                updateField('metadata', { ...formData.metadata, kinderen });
                              }}
                              className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                            >
                              <option value="dagopvang">Dagopvang</option>
                              <option value="bso">BSO</option>
                              <option value="gastouder">Gastouder</option>
                            </select>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
                
                {type === 'income' && formData.category === 'child-benefit' && (
                  <div className="bg-purple-50 p-4 rounded-lg space-y-3">
                    <h4 className="font-semibold text-gray-800">Kinderbijslag details</h4>
                    <p className="text-xs text-gray-600">Voeg kinderen toe met hun leeftijd (0-17 jaar)</p>
                    
                    <button
                      type="button"
                      onClick={() => {
                        const leeftijden = formData.metadata?.kinderenLeeftijden || [];
                        updateField('metadata', {
                          ...formData.metadata,
                          kinderenLeeftijden: [...leeftijden, 0]
                        });
                      }}
                      className="text-sm bg-purple-600 text-white px-3 py-1 rounded hover:bg-purple-700"
                    >
                      + Voeg kind toe
                    </button>
                    
                    {(formData.metadata?.kinderenLeeftijden || []).map((leeftijd, index) => (
                      <div key={index} className="bg-white p-3 rounded flex items-center gap-3">
                        <span className="text-sm font-medium">Kind {index + 1}:</span>
                        <input
                          type="number"
                          min="0"
                          max="17"
                          value={leeftijd}
                          onChange={(e) => {
                            const leeftijden = [...(formData.metadata?.kinderenLeeftijden || [])];
                            leeftijden[index] = parseInt(e.target.value) || 0;
                            updateField('metadata', { ...formData.metadata, kinderenLeeftijden: leeftijden });
                          }}
                          className="flex-1 px-2 py-1 border border-gray-300 rounded text-sm"
                          placeholder="Leeftijd (0-17)"
                        />
                        <button
                          type="button"
                          onClick={() => {
                            const leeftijden = [...(formData.metadata?.kinderenLeeftijden || [])];
                            leeftijden.splice(index, 1);
                            updateField('metadata', { ...formData.metadata, kinderenLeeftijden: leeftijden });
                          }}
                          className="text-red-500 text-xs hover:text-red-700"
                        >
                          Verwijder
                        </button>
                      </div>
                    ))}
                  </div>
                )}
                
                {type === 'income' && formData.category === 'child-budget' && (
                  <div className="bg-pink-50 p-4 rounded-lg space-y-3">
                    <h4 className="font-semibold text-gray-800">Kindgebonden budget details</h4>
                    
                    <div>
                      <label className="block text-sm text-gray-700 mb-1">Aantal kinderen</label>
                      <input
                        type="number"
                        min="0"
                        value={formData.metadata?.aantalKinderen || 0}
                        onChange={(e) => updateField('metadata', { 
                          ...formData.metadata, 
                          aantalKinderen: parseInt(e.target.value) || 0 
                        })}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                      />
                    </div>
                    
                    <label className="flex items-center gap-2">
                      <input 
                        type="checkbox" 
                        checked={formData.metadata?.fiscaalPartner || false}
                        onChange={(e) => updateField('metadata', { 
                          ...formData.metadata, 
                          fiscaalPartner: e.target.checked 
                        })}
                        className="w-4 h-4"
                      />
                      <span className="text-sm">Fiscaal partner</span>
                    </label>
                  </div>
                )}
              </div>
              
              <div className="p-6 border-t flex gap-3 justify-end">
                <button
                  type="button"
                  onClick={onCancel}
                  className="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
                >
                  Annuleren
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors"
                >
                  Wijzigingen opslaan
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    function AddExpenseDialog({ isOpen, onSelectCategory, onCancel }) {
      if (!isOpen) return null;
      
      const categories = [
        { id: 'housing', name: 'Woning', emoji: 'üè†', description: 'Hypotheek, huur, onderhoud', type: 'housing' },
        { id: 'recurring', name: 'Reguliere periodieke uitgaven', emoji: 'üîÑ', description: 'Abonnementen, verzekeringen, energiekosten', type: 'recurring' },
        { id: 'children', name: 'Kindgerelateerde uitgaven', emoji: 'üë∂', description: 'Kinderopvang, schoolkosten', type: 'children' },
        { id: 'other', name: 'Overige lasten', emoji: 'üõí', description: 'Boodschappen, kleding, verzorging, restaurants, vakanties', type: 'other' }
      ];
      
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6 border-b">
              <h2 className="text-2xl font-bold text-dark">Voeg toe aan plan</h2>
            </div>
            
            <div className="p-6">
              <div className="mb-6">
                <div className="flex items-center gap-3 mb-4">
                  <div className="w-12 h-12 bg-accent rounded-xl flex items-center justify-center text-2xl">üí∞</div>
                  <h3 className="text-xl font-semibold">Uitgaven</h3>
                </div>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {categories.map(category => (
                  <button
                    key={category.id}
                    onClick={() => onSelectCategory(category)}
                    className="flex items-start gap-4 p-4 border-2 border-gray-200 rounded-lg hover:border-primary hover:bg-primary/5 transition-all text-left"
                  >
                    <div className="text-4xl">{category.emoji}</div>
                    <div className="flex-1">
                      <div className="font-semibold text-dark mb-1">{category.name}</div>
                      <div className="text-sm text-gray-600">{category.description}</div>
                    </div>
                  </button>
                ))}
              </div>
            </div>
            
            <div className="p-6 border-t flex justify-end">
              <button onClick={onCancel} className="px-6 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                Annuleren
              </button>
            </div>
          </div>
        </div>
      );
    }

    function AddIncomeDialog({ isOpen, onSelectCategory, onCancel }) {
      if (!isOpen) return null;
      
      const categories = [
        { id: 'salary', name: 'Salaris / Loon', emoji: 'üíº', description: 'Regulier inkomen uit werk', type: 'salary' },
        { id: 'childcare', name: 'Kinderopvangtoeslag', emoji: 'üë∂', description: 'Automatisch berekend o.b.v. verzamelinkomen', type: 'childcare' },
        { id: 'child-benefit', name: 'Kinderbijslag', emoji: 'üçº', description: 'Automatisch berekend o.b.v. leeftijden', type: 'child-benefit' },
        { id: 'child-budget', name: 'Kindgebonden budget', emoji: 'üë®‚Äçüë©‚Äçüëß', description: 'Automatisch berekend o.b.v. verzamelinkomen', type: 'child-budget' },
        { id: 'other-income', name: 'Overig inkomen', emoji: 'üí∞', description: 'Freelance, bijverdiensten, dividend', type: 'other-income' }
      ];
      
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6 border-b">
              <h2 className="text-2xl font-bold text-dark">Voeg inkomen toe</h2>
            </div>
            
            <div className="p-6">
              <div className="mb-6">
                <div className="flex items-center gap-3 mb-4">
                  <div className="w-12 h-12 bg-primary rounded-xl flex items-center justify-center text-2xl">üí∞</div>
                  <h3 className="text-xl font-semibold">Inkomsten</h3>
                </div>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {categories.map(category => (
                  <button
                    key={category.id}
                    onClick={() => onSelectCategory(category)}
                    className="flex items-start gap-4 p-4 border-2 border-gray-200 rounded-lg hover:border-primary hover:bg-primary/5 transition-all text-left"
                  >
                    <div className="text-4xl">{category.emoji}</div>
                    <div className="flex-1">
                      <div className="font-semibold text-dark mb-1">{category.name}</div>
                      <div className="text-sm text-gray-600">{category.description}</div>
                    </div>
                  </button>
                ))}
              </div>
            </div>
            
            <div className="p-6 border-t flex justify-end">
              <button onClick={onCancel} className="px-6 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                Annuleren
              </button>
            </div>
          </div>
        </div>
      );
    }

    function HousingDialog({ isOpen, item, onSave, onCancel }) {
      const [formData, setFormData] = useState(item || {});
      
      useEffect(() => {
        setFormData(item || {});
      }, [item]);
      
      if (!isOpen) return null;
      
      const handleSubmit = (e) => {
        e.preventDefault();
        
        // Calculate remaining months from current date to end date
        const currentDate = new Date();
        const endDate = new Date(formData.endDate);
        const monthsDiff = (endDate.getFullYear() - currentDate.getFullYear()) * 12 
                          + (endDate.getMonth() - currentDate.getMonth());
        
        const principal = formData.outstandingAmount || 0;
        const annualRate = (formData.interestRate || 0) / 100;
        const monthlyRate = annualRate / 12;
        const remainingMonths = Math.max(1, monthsDiff);
        
        let monthlyPayment = 0;
        
        if (formData.mortgageType === 'annuity') {
          if (remainingMonths > 0 && monthlyRate > 0) {
            monthlyPayment = principal * (monthlyRate * Math.pow(1 + monthlyRate, remainingMonths)) / 
                            (Math.pow(1 + monthlyRate, remainingMonths) - 1);
          }
        } else if (formData.mortgageType === 'interest-only') {
          monthlyPayment = principal * monthlyRate;
        }
        
        const updatedData = {
          ...formData,
          amount: monthlyPayment,
          frequency: 'monthly',
          category: 'housing',
          startYear: currentDate.getFullYear(),
          endYear: endDate.getFullYear(),
          startDate: currentDate.toISOString().split('T')[0],
          remainingMonths: remainingMonths
        };
        
        onSave(updatedData);
      };
      
      const updateField = (field, value) => {
        setFormData({ ...formData, [field]: value });
      };
      
      // Calculate remaining time for display
      const getRemainingTime = () => {
        if (!formData.endDate) return '';
        const currentDate = new Date();
        const endDate = new Date(formData.endDate);
        const monthsDiff = (endDate.getFullYear() - currentDate.getFullYear()) * 12 
                          + (endDate.getMonth() - currentDate.getMonth());
        const years = Math.floor(monthsDiff / 12);
        const months = monthsDiff % 12;
        return `${monthsDiff} maanden (${years} jaar${months > 0 ? ` en ${months} maanden` : ''})`;
      };
      
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <form onSubmit={handleSubmit}>
              <div className="p-6 border-b">
                <h2 className="text-xl font-bold text-dark">üè† Hypotheek toevoegen/bewerken</h2>
              </div>
              
              <div className="p-6 space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Naam</label>
                  <input
                    type="text"
                    value={formData.name || 'Hypotheek'}
                    onChange={(e) => updateField('name', e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                    required
                    placeholder="Bijv. Hypotheek deel 1"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Type hypotheek</label>
                  <select
                    value={formData.mortgageType || 'annuity'}
                    onChange={(e) => updateField('mortgageType', e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                  >
                    <option value="annuity">Annu√Øtair (met aflossing)</option>
                    <option value="interest-only">Aflossingsvrij</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Huidig uitstaand bedrag</label>
                  <div className="flex items-center border border-gray-300 rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-primary focus-within:border-transparent">
                    <span className="px-3 py-2 text-gray-500 bg-gray-50 border-r">‚Ç¨</span>
                    <input
                      type="number"
                      value={formData.outstandingAmount || 0}
                      onChange={(e) => updateField('outstandingAmount', parseFloat(e.target.value) || 0)}
                      className="flex-1 px-3 py-2 border-0 focus:ring-0"
                      required
                      min="0"
                      step="1"
                    />
                  </div>
                  <div className="text-xs text-gray-500 mt-1">
                    De huidige restschuld (per vandaag)
                  </div>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Rentepercentage</label>
                  <div className="flex items-center border border-gray-300 rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-primary focus-within:border-transparent">
                    <input
                      type="number"
                      value={formData.interestRate || 0}
                      onChange={(e) => updateField('interestRate', parseFloat(e.target.value) || 0)}
                      className="flex-1 px-3 py-2 border-0 focus:ring-0"
                      required
                      min="0"
                      max="20"
                      step="0.01"
                    />
                    <span className="px-3 py-2 text-gray-500 bg-gray-100 border-l">%</span>
                  </div>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Einddatum hypotheek</label>
                  <input
                    type="date"
                    value={formData.endDate || ''}
                    onChange={(e) => updateField('endDate', e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                    required
                  />
                  {formData.endDate && (
                    <div className="text-xs text-gray-500 mt-1">
                      Resterende looptijd: {getRemainingTime()}
                    </div>
                  )}
                </div>
              </div>
              
              <div className="p-6 border-t flex gap-3 justify-end">
                <button type="button" onClick={onCancel} className="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                  Annuleren
                </button>
                <button type="submit" className="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors">
                  Opslaan
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }
    
    function AssetDialog({ isOpen, item, onSave, onCancel }) {
      const [formData, setFormData] = useState(item || {});
      
      useEffect(() => {
        setFormData(item || {});
      }, [item]);
      
      if (!isOpen) return null;
      
      const handleSubmit = (e) => {
        e.preventDefault();
        onSave(formData);
      };
      
      const updateField = (field, value) => {
        setFormData({ ...formData, [field]: value });
      };
      
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <form onSubmit={handleSubmit}>
              <div className="p-6 border-b">
                <h2 className="text-xl font-bold text-dark">üíé Bezit toevoegen/bewerken</h2>
              </div>
              
              <div className="p-6 space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Naam</label>
                  <input
                    type="text"
                    value={formData.name || ''}
                    onChange={(e) => updateField('name', e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                    required
                    placeholder="Bijv. Woning, Aandelen, Crypto"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Type</label>
                  <select
                    value={formData.type || 'property'}
                    onChange={(e) => updateField('type', e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                  >
                    <option value="property">üè† Vastgoed</option>
                    <option value="stocks">üìà Aandelen</option>
                    <option value="crypto">‚Çø Crypto</option>
                    <option value="cash">üíµ Cash / Spaarrekening</option>
                    <option value="other">üíº Overig</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Huidige waarde (‚Ç¨)</label>
                  <div className="flex items-center border border-gray-300 rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-primary focus-within:border-transparent">
                    <span className="px-3 py-2 text-gray-500 bg-gray-50 border-r">‚Ç¨</span>
                    <input
                      type="number"
                      value={formData.value || 0}
                      onChange={(e) => updateField('value', parseFloat(e.target.value) || 0)}
                      className="flex-1 px-3 py-2 border-0 focus:ring-0"
                      required
                      min="0"
                      step="1000"
                    />
                  </div>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Groei per jaar (%)</label>
                  <div className="flex items-center border border-gray-300 rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-primary focus-within:border-transparent">
                    <input
                      type="number"
                      value={formData.growthRate || 0}
                      onChange={(e) => updateField('growthRate', parseFloat(e.target.value) || 0)}
                      className="flex-1 px-3 py-2 border-0 focus:ring-0"
                      min="-100"
                      max="100"
                      step="0.1"
                    />
                    <span className="px-3 py-2 text-gray-500 bg-gray-100 border-l">%</span>
                  </div>
                  <p className="text-xs text-gray-500 mt-1">Bijv. 7% voor aandelen, 2% voor vastgoed</p>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Startjaar</label>
                  <input
                    type="number"
                    value={formData.startYear || new Date().getFullYear()}
                    onChange={(e) => updateField('startYear', parseInt(e.target.value) || new Date().getFullYear())}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                    required
                    min="2000"
                    max="2100"
                  />
                </div>
              </div>
              
              <div className="p-6 border-t flex gap-3 justify-end">
                <button type="button" onClick={onCancel} className="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                  Annuleren
                </button>
                <button type="submit" className="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors">
                  Opslaan
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }
    
    function LiabilityDialog({ isOpen, item, onSave, onCancel }) {
      const [formData, setFormData] = useState(item || {});
      
      useEffect(() => {
        setFormData(item || {});
      }, [item]);
      
      if (!isOpen) return null;
      
      const handleSubmit = (e) => {
        e.preventDefault();
        onSave(formData);
      };
      
      const updateField = (field, value) => {
        setFormData({ ...formData, [field]: value });
      };
      
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <form onSubmit={handleSubmit}>
              <div className="p-6 border-b">
                <h2 className="text-xl font-bold text-dark">üí≥ Schuld toevoegen/bewerken</h2>
              </div>
              
              <div className="p-6 space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Naam</label>
                  <input
                    type="text"
                    value={formData.name || ''}
                    onChange={(e) => updateField('name', e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                    required
                    placeholder="Bijv. Studieschuld, Lening"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Type</label>
                  <select
                    value={formData.type || 'other'}
                    onChange={(e) => updateField('type', e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                  >
                    <option value="student-loan">üéì Studieschuld</option>
                    <option value="personal-loan">üí∞ Persoonlijke lening</option>
                    <option value="credit-card">üí≥ Creditcard</option>
                    <option value="other">üìã Overig</option>
                  </select>
                  <p className="text-xs text-gray-500 mt-1">Hypotheek wordt automatisch toegevoegd bij uitgaven</p>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Bedrag (‚Ç¨)</label>
                  <div className="flex items-center border border-gray-300 rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-primary focus-within:border-transparent">
                    <span className="px-3 py-2 text-gray-500 bg-gray-50 border-r">‚Ç¨</span>
                    <input
                      type="number"
                      value={formData.amount || 0}
                      onChange={(e) => updateField('amount', parseFloat(e.target.value) || 0)}
                      className="flex-1 px-3 py-2 border-0 focus:ring-0"
                      required
                      min="0"
                      step="100"
                    />
                  </div>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Rentepercentage (%)</label>
                  <div className="flex items-center border border-gray-300 rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-primary focus-within:border-transparent">
                    <input
                      type="number"
                      value={formData.interestRate || 0}
                      onChange={(e) => updateField('interestRate', parseFloat(e.target.value) || 0)}
                      className="flex-1 px-3 py-2 border-0 focus:ring-0"
                      min="0"
                      max="100"
                      step="0.1"
                    />
                    <span className="px-3 py-2 text-gray-500 bg-gray-100 border-l">%</span>
                  </div>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Startjaar</label>
                  <input
                    type="number"
                    value={formData.startYear || new Date().getFullYear()}
                    onChange={(e) => updateField('startYear', parseInt(e.target.value) || new Date().getFullYear())}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                    required
                    min="2000"
                    max="2100"
                  />
                </div>
              </div>
              
              <div className="p-6 border-t flex gap-3 justify-end">
                <button type="button" onClick={onCancel} className="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                  Annuleren
                </button>
                <button type="submit" className="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors">
                  Opslaan
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }
    
    function KPICard({ icon, label, value, color = 'primary' }) {
      const colorClasses = {
        primary: 'border-primary bg-primary/5',
        secondary: 'border-secondary bg-secondary/5',
        accent: 'border-accent bg-accent/5',
      };
      
      return (
        <div className={`bg-white rounded-lg shadow p-4 border-l-4 ${colorClasses[color]}`}>
          <div className="flex items-center gap-2 mb-1">
            <span className="text-2xl">{icon}</span>
          </div>
          <div className="text-sm text-gray-600 mb-1">{label}</div>
          <div className="text-xl font-bold text-dark">{value}</div>
        </div>
      );
    }
    
    function App() {
      const [incomeItems, setIncomeItems] = useState([
        { id: 1, name: 'Salaris', amount: 80000, frequency: 'yearly', growthRate: 2, startYear: 2026, endYear: null, category: 'salary' }
      ]);
      
      const [expenseItems, setExpenseItems] = useState([
        { id: 1, name: 'Levensonderhoud', amount: 2500, frequency: 'monthly', startYear: 2026, endYear: null, category: 'other', adjustForInflation: true }
      ]);
      
      const [targetNetWorth, setTargetNetWorth] = useState(1500000);
      const [wozWaarde, setWozWaarde] = useState(0);
      
      // Assets: Bezittingen (woning, crypto, aandelen, cash)
      const [assets, setAssets] = useState([
        // Example: { id: 1, name: 'Woning', value: 450000, type: 'property', growthRate: 2, startYear: 2020 }
      ]);
      
      // Liabilities: Schulden (hypotheek, studieschuld, etc.)
      const [liabilities, setLiabilities] = useState([
        // Hypotheek wordt automatisch toegevoegd vanuit expenses met category 'housing'
        // Example: { id: 1, name: 'Studieschuld', amount: 20000, interestRate: 0, type: 'student-loan', startYear: 2018 }
      ]);
      
      const [assumptions, setAssumptions] = useState({
        inflationRate: 2.0,
        investmentReturn: 7.0,
        safeWithdrawalRate: 4.0,
      });
      
      const [editDialog, setEditDialog] = useState({ isOpen: false, type: null, item: null });
      const [showCategoryDialog, setShowCategoryDialog] = useState(false);
      const [showIncomeCategoryDialog, setShowIncomeCategoryDialog] = useState(false);
      const [housingDialog, setHousingDialog] = useState({ isOpen: false, item: null });
      const [assetDialog, setAssetDialog] = useState({ isOpen: false, item: null });
      const [liabilityDialog, setLiabilityDialog] = useState({ isOpen: false, item: null });
      
      const [projections, setProjections] = useState(null);
      
      useEffect(() => {
        try {
          const currentYear = new Date().getFullYear();
          const endYear = currentYear + 50;
          
          // Calculate current net worth from assets and liabilities
          const totalAssets = calculateAssetsValue(assets, currentYear);
          const propertyValue = calculatePropertyValue(assets, currentYear);
          const liabilitiesData = calculateLiabilitiesValue(liabilities, expenseItems, currentYear);
          const currentNetWorth = (totalAssets - propertyValue) - (liabilitiesData.totalLiabilities - liabilitiesData.mortgageLiability);
          
          const timeline = projectNetWorth({
            startYear: currentYear,
            endYear: endYear,
            startNetWorth: currentNetWorth,
            incomes: incomeItems,
            expenses: expenseItems,
            assumptions: assumptions,
            assets: assets,
            liabilities: liabilities
          });
          
          const fireYear = findFireYear(timeline, targetNetWorth);
          
          const firstYearCashflow = timeline[0]?.cashflow;
          const monthlySavings = firstYearCashflow ? monthlySavingsFromCashflow(firstYearCashflow) : 0;
          
          setProjections({
            timeline,
            fireYear,
            monthlySavings,
            yearsToFire: fireYear ? fireYear - currentYear : null
          });
        } catch (error) {
          console.error('Calculation error:', error);
          setProjections(null);
      }
      }, [incomeItems, expenseItems, targetNetWorth, assumptions, assets, liabilities, wozWaarde]);
      
      const addIncome = () => {
        setShowIncomeCategoryDialog(true);
      };
      
      const handleIncomeCategorySelect = (category) => {
        setShowIncomeCategoryDialog(false);
        
        const newIncome = {
          id: Date.now(),
          name: category.name,
          amount: 0,
          frequency: 'yearly',
          growthRate: 0,
          startYear: new Date().getFullYear(),
          endYear: null,
          category: category.type,
          partner: 'partner1', // Nieuwe veld
          metadata: category.type === 'childcare' ? { kinderen: [] } :
                    category.type === 'child-benefit' ? { kinderenLeeftijden: [] } :
                    category.type === 'child-budget' ? { aantalKinderen: 0, fiscaalPartner: false } : null
        };
        setEditDialog({ isOpen: true, type: 'income', item: newIncome });
      };

      const addExpense = () => {
        setShowCategoryDialog(true);
      };

      const handleCategorySelect = (category) => {
        setShowCategoryDialog(false);
        
        if (category.type === 'housing') {
          const newHousing = {
            id: Date.now(),
            name: 'Hypotheek',
            mortgageType: 'annuity',
            outstandingAmount: 0,
            interestRate: 0,
            remainingMonths: 360,
            startYear: new Date().getFullYear(),
            endYear: null,
            category: 'housing'
          };
          setHousingDialog({ isOpen: true, item: newHousing });
        } else {
          const newExpense = {
            id: Date.now(),
            name: category.name,
            amount: 0,
            frequency: 'monthly',
            startYear: new Date().getFullYear(),
            endYear: null,
            category: category.type,
            adjustForInflation: category.type === 'other'
          };
          setEditDialog({ isOpen: true, type: 'expense', item: newExpense });
        }
      };

      const saveHousing = (item) => {
        const existingIndex = expenseItems.findIndex(i => i.id === item.id);
        if (existingIndex >= 0) {
          const updated = [...expenseItems];
          updated[existingIndex] = item;
          setExpenseItems(updated);
        } else {
          setExpenseItems([...expenseItems, item]);
        }
        setHousingDialog({ isOpen: false, item: null });
      };

      const editItem = (type, item) => {
        if (type === 'expense' && item.category === 'housing') {
          // Convert years to dates for the form
          const itemWithDates = { 
            ...item,
            startDate: item.startYear ? `${item.startYear}-01-01` : '',
            endDate: item.endYear ? `${item.endYear}-12-31` : ''
          };
          setHousingDialog({ isOpen: true, item: itemWithDates });
        } else {
          setEditDialog({ isOpen: true, type, item: { ...item } });
        }
      };

      const saveItem = (item) => {
        if (editDialog.type === 'income') {
          const existingIndex = incomeItems.findIndex(i => i.id === item.id);
          if (existingIndex >= 0) {
            const updated = [...incomeItems];
            updated[existingIndex] = item;
            setIncomeItems(updated);
          } else {
            setIncomeItems([...incomeItems, item]);
          }
        } else {
          const existingIndex = expenseItems.findIndex(i => i.id === item.id);
          if (existingIndex >= 0) {
            const updated = [...expenseItems];
            updated[existingIndex] = item;
            setExpenseItems(updated);
          } else {
            setExpenseItems([...expenseItems, item]);
          }
        }
        setEditDialog({ isOpen: false, type: null, item: null });
      };

      const deleteItem = (type, id) => {
        if (type === 'income') {
          setIncomeItems(incomeItems.filter(i => i.id !== id));
        } else {
          setExpenseItems(expenseItems.filter(i => i.id !== id));
        }
      };
      
      // Asset handlers
      const addAsset = () => {
        const newAsset = {
          id: Date.now(),
          name: '',
          value: 0,
          type: 'property',
          growthRate: 0,
          startYear: new Date().getFullYear()
        };
        setAssetDialog({ isOpen: true, item: newAsset });
      };
      
      const editAsset = (asset) => {
        setAssetDialog({ isOpen: true, item: { ...asset } });
      };
      
      const saveAsset = (asset) => {
        const existingIndex = assets.findIndex(a => a.id === asset.id);
        if (existingIndex >= 0) {
          const updated = [...assets];
          updated[existingIndex] = asset;
          setAssets(updated);
        } else {
          setAssets([...assets, asset]);
        }
        setAssetDialog({ isOpen: false, item: null });
      };
      
      const deleteAsset = (id) => {
        if (confirm('Weet je zeker dat je dit bezit wilt verwijderen?')) {
          setAssets(assets.filter(a => a.id !== id));
        }
      };
      
      // Liability handlers
      const addLiability = () => {
        const newLiability = {
          id: Date.now(),
          name: '',
          amount: 0,
          interestRate: 0,
          type: 'other',
          startYear: new Date().getFullYear()
        };
        setLiabilityDialog({ isOpen: true, item: newLiability });
      };
      
      const editLiability = (liability) => {
        setLiabilityDialog({ isOpen: true, item: { ...liability } });
      };
      
      const saveLiability = (liability) => {
        const existingIndex = liabilities.findIndex(l => l.id === liability.id);
        if (existingIndex >= 0) {
          const updated = [...liabilities];
          updated[existingIndex] = liability;
          setLiabilities(updated);
        } else {
          setLiabilities([...liabilities, liability]);
        }
        setLiabilityDialog({ isOpen: false, item: null });
      };
      
      const deleteLiability = (id) => {
        if (confirm('Weet je zeker dat je deze schuld wilt verwijderen?')) {
          setLiabilities(liabilities.filter(l => l.id !== id));
        }
      };
      
      return (
        <div className="min-h-screen bg-light">
          <header className="bg-white shadow-sm border-b">
            <div className="max-w-7xl mx-auto px-4 py-4">
              <h1 className="text-2xl font-bold text-primary">Financi√´le planningstool</h1>
              <p className="text-sm text-gray-600">Bereken je financi√´le positie en vermogensdoel</p>
            </div>
          </header>
          
          <div className="max-w-7xl mx-auto px-4 py-6">
            <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
              
              <div className="lg:col-span-1 space-y-4">
                <div className="bg-white rounded-lg shadow p-4">
                  <div className="flex items-center justify-between mb-3">
                    <h2 className="font-semibold flex items-center gap-2">
                      üí∞ Inkomsten
                      <span className="text-xs text-gray-500">({incomeItems.length})</span>
                    </h2>
                    <button onClick={addIncome} className="text-primary hover:text-primary-dark text-xl" title="Voeg inkomen toe">+</button>
                  </div>
                  <ItemList 
                    items={incomeItems} 
                    type="income" 
                    onEdit={editItem} 
                    onDelete={deleteItem}
                    incomes={incomeItems}
                    expenses={expenseItems}
                    wozWaarde={wozWaarde}
                  />
                </div>
                
                <div className="bg-white rounded-lg shadow p-4">
                  <div className="flex items-center justify-between mb-3">
                    <h2 className="font-semibold flex items-center gap-2">
                      üõí Uitgaven
                      <span className="text-xs text-gray-500">({expenseItems.length})</span>
                    </h2>
                    <button onClick={addExpense} className="text-primary hover:text-primary-dark text-xl" title="Voeg uitgave toe">+</button>
                  </div>
                  <ItemList 
                    items={expenseItems} 
                    type="expense" 
                    onEdit={editItem} 
                    onDelete={deleteItem}
                    incomes={incomeItems}
                    expenses={expenseItems}
                    wozWaarde={wozWaarde}
                  />
                </div>
                
                <div className="bg-white rounded-lg shadow p-4">
                  <div className="flex items-center justify-between mb-3">
                    <h2 className="font-semibold flex items-center gap-2">
                      üíé Bezittingen
                      <span className="text-xs text-gray-500">({assets.length})</span>
                    </h2>
                    <button onClick={addAsset} className="text-primary hover:text-primary-dark text-xl" title="Voeg bezit toe">+</button>
                  </div>
                  {assets.length === 0 ? (
                    <div className="text-sm text-gray-400 italic py-2">
                      Nog geen bezittingen toegevoegd
                    </div>
                  ) : (
                    <div className="space-y-2">
                      {assets.map(asset => (
                        <div 
                          key={asset.id}
                          className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
                        >
                          <div className="flex-1 cursor-pointer" onClick={() => editAsset(asset)}>
                            <div className="font-medium text-sm flex items-center gap-1">
                              {asset.type === 'property' && 'üè†'}
                              {asset.type === 'stocks' && 'üìà'}
                              {asset.type === 'crypto' && '‚Çø'}
                              {asset.type === 'cash' && 'üíµ'}
                              {asset.type === 'other' && 'üíº'}
                              {asset.name}
                            </div>
                            <div className="text-xs text-gray-600">
                              {formatCurrency(asset.value)}
                              {asset.growthRate > 0 && ` ‚Ä¢ ${asset.growthRate}% groei/jaar`}
                            </div>
                            <div className="text-xs text-gray-500">
                              Vanaf {asset.startYear}
                            </div>
                          </div>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              deleteAsset(asset.id);
                            }}
                            className="ml-2 text-red-500 hover:text-red-700 text-sm"
                          >
                            üóëÔ∏è
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
                
                <div className="bg-white rounded-lg shadow p-4">
                  <div className="flex items-center justify-between mb-3">
                    <h2 className="font-semibold flex items-center gap-2">
                      üí≥ Schulden
                      <span className="text-xs text-gray-500">({liabilities.length})</span>
                    </h2>
                    <button onClick={addLiability} className="text-primary hover:text-primary-dark text-xl" title="Voeg schuld toe">+</button>
                  </div>
                  <div className="text-xs text-gray-500 mb-2 italic">
                    Hypotheek wordt automatisch berekend via uitgaven
                  </div>
                  {liabilities.length === 0 ? (
                    <div className="text-sm text-gray-400 italic py-2">
                      Nog geen schulden toegevoegd
                    </div>
                  ) : (
                    <div className="space-y-2">
                      {liabilities.map(liability => (
                        <div 
                          key={liability.id}
                          className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
                        >
                          <div className="flex-1 cursor-pointer" onClick={() => editLiability(liability)}>
                            <div className="font-medium text-sm flex items-center gap-1">
                              {liability.type === 'student-loan' && 'üéì'}
                              {liability.type === 'personal-loan' && 'üí∞'}
                              {liability.type === 'credit-card' && 'üí≥'}
                              {liability.type === 'other' && 'üìã'}
                              {liability.name}
                            </div>
                            <div className="text-xs text-gray-600">
                              {formatCurrency(liability.amount)}
                              {liability.interestRate > 0 && ` ‚Ä¢ ${liability.interestRate}% rente`}
                            </div>
                            <div className="text-xs text-gray-500">
                              Vanaf {liability.startYear}
                            </div>
                          </div>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              deleteLiability(liability.id);
                            }}
                            className="ml-2 text-red-500 hover:text-red-700 text-sm"
                          >
                            üóëÔ∏è
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
                
                <div className="bg-white rounded-lg shadow p-4">
                  <h2 className="font-semibold mb-3">‚öôÔ∏è Instellingen</h2>
                 <div className="space-y-3">
                    <div>
                      <label className="block text-xs text-gray-600 mb-1">Vermogensdoel</label>
                      <div className="flex items-center border border-gray-300 rounded-lg overflow-hidden">
                        <span className="px-2 py-1.5 text-sm text-gray-500 bg-gray-50 border-r">‚Ç¨</span>
                        <input
                          type="number"
                          value={targetNetWorth}
                          onChange={(e) => setTargetNetWorth(parseFloat(e.target.value) || 0)}
                          className="flex-1 px-2 py-1.5 text-sm border-0 focus:ring-1 focus:ring-primary"
                          step="10000"
                        />
                      </div>
                    </div>
                    <div>
                      <label className="block text-xs text-gray-600 mb-1">WOZ-waarde eigen woning</label>
                      <div className="flex items-center border border-gray-300 rounded-lg overflow-hidden">
                        <span className="px-2 py-1.5 text-sm text-gray-500 bg-gray-50 border-r">‚Ç¨</span>
                        <input
                          type="number"
                          value={wozWaarde}
                          onChange={(e) => setWozWaarde(parseFloat(e.target.value) || 0)}
                          className="flex-1 px-2 py-1.5 text-sm border-0 focus:ring-1 focus:ring-primary"
                          step="1000"
                          placeholder="350000"
                        />
                      </div>
                      <p className="text-xs text-gray-500 mt-1">Voor eigenwoningforfait berekening</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <div className="lg:col-span-3 space-y-6">
                
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                  <KPICard 
                    icon="üéØ"
                    label="Jaar tot vermogensdoel"
                    value={projections?.yearsToFire ? `${projections.yearsToFire} jaar` : 'Berekenen...'}
                    color="primary"
                  />
                  <KPICard 
                    icon="ü™ô"
                    label="Vermogensdoel"
                    value={formatCurrency(targetNetWorth)}
                    color="secondary"
                  />
                 <KPICard 
                    icon="üìä"
                    label="Huidig liquide vermogen"
                    value={projections?.timeline[0] ? formatCurrency(projections.timeline[0].liquidNetWorth) : formatCurrency(0)}
                    color="accent"
                  />
                <div className="relative group">
                    <KPICard 
                      icon="‚ÜïÔ∏è"
                      label="Maandelijks saldo"
                      value={projections?.monthlySavings ? formatCurrency(projections.monthlySavings) : 'Berekenen...'}
                      color="primary"
                    />
                    {projections?.timeline[0]?.cashflow && (
                      <div className="absolute left-0 top-full mt-2 w-72 bg-white border border-gray-200 rounded-lg shadow-lg p-3 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-10">
                        <p className="text-xs font-semibold text-gray-700 mb-2">Belastingberekening {projections.timeline[0].year}:</p>
                        <div className="space-y-1 text-xs">
                          <div className="flex justify-between">
                            <span>üí∞ Bruto inkomen totaal:</span>
                            <span className="font-semibold">{formatCurrency(projections.timeline[0].cashflow.grossIncome)}</span>
                          </div>
                          {projections.timeline[0].cashflow.partner2GrossIncome > 0 && (
                            <>
                              <div className="flex justify-between text-gray-600 text-xs pl-3">
                                <span>‚Üí Partner 1:</span>
                                <span>{formatCurrency(projections.timeline[0].cashflow.partner1GrossIncome)}</span>
                              </div>
                              <div className="flex justify-between text-gray-600 text-xs pl-3">
                                <span>‚Üí Partner 2:</span>
                                <span>{formatCurrency(projections.timeline[0].cashflow.partner2GrossIncome)}</span>
                              </div>
                            </>
                          )}
                          <div className="flex justify-between text-red-600">
                            <span>üè¶ Loonheffing (ingehouden):</span>
                            <span className="font-semibold">-{formatCurrency(projections.timeline[0].cashflow.loonheffing)}</span>
                          </div>
                          <div className="border-t pt-1 mt-1">
                            <div className="flex justify-between text-blue-600">
                              <span>üè† Hypotheekrenteaftrek:</span>
                              <span className="font-semibold">-{formatCurrency(projections.timeline[0].cashflow.hypotheekrenteAftrek)}</span>
                            </div>
                            {projections.timeline[0].cashflow.iack > 0 && (
                              <div className="flex justify-between text-green-600">
                                <span>üë∂ IACK (combinatiekorting):</span>
                                <span className="font-semibold">-{formatCurrency(projections.timeline[0].cashflow.iack)}</span>
                              </div>
                            )}
                          </div>
                          <div className="border-t pt-1 mt-1">
                            <div className="flex justify-between text-red-700">
                              <span>üí≥ Werkelijke belasting:</span>
                              <span className="font-semibold">-{formatCurrency(projections.timeline[0].cashflow.werkelijkeBelasting)}</span>
                            </div>
                            <div className="flex justify-between text-green-700 font-semibold">
                              <span>üí∏ Teruggaaf IB:</span>
                              <span>+{formatCurrency(projections.timeline[0].cashflow.teruggaafIB)}</span>
                            </div>
                          </div>
                          <div className="flex justify-between font-bold pt-1 border-t text-green-800">
                            <span>‚úÖ Netto inkomen:</span>
                            <span>{formatCurrency(projections.timeline[0].cashflow.netIncome)}</span>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                  {projections?.timeline[0]?.cashflow?.toeslagen > 0 && (
                    <div className="relative group">
                      <KPICard 
                        icon="üéÅ"
                        label="Jaarlijkse toeslagen"
                        value={formatCurrency(projections.timeline[0].cashflow.toeslagen)}
                        color="accent"
                      />
                      <div className="absolute left-0 top-full mt-2 w-64 bg-white border border-gray-200 rounded-lg shadow-lg p-3 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-10">
                        <p className="text-xs font-semibold text-gray-700 mb-2">Samenstelling toeslagen:</p>
                        {incomeItems.filter(i => ['childcare', 'child-benefit', 'child-budget'].includes(i.category)).map(item => (
                          <div key={item.id} className="text-xs text-gray-600 flex justify-between mb-1">
                            <span>{item.category === 'childcare' ? 'üë∂ Kinderopvang' : item.category === 'child-benefit' ? 'üçº Kinderbijslag' : 'üë®‚Äçüë©‚Äçüëß Kindgebonden budget'}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                 {projections?.timeline[0]?.cashflow?.teruggaafIB > 0 && (
                    <KPICard 
                      icon="üí∏"
                      label="Teruggaaf IB (jaarlijks)"
                      value={formatCurrency(projections.timeline[0].cashflow.teruggaafIB)}
                      color="primary"
                    />
                  )}
                 {projections?.timeline[0]?.cashflow?.iack > 0 && (
                    <div className="relative group">
                      <KPICard 
                        icon="üë∂"
                        label="IACK (combinatiekorting)"
                        value={formatCurrency(projections.timeline[0].cashflow.iack)}
                        color="accent"
                      />
                      <div className="absolute left-0 top-full mt-2 w-64 bg-white border border-gray-200 rounded-lg shadow-lg p-3 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-10">
                        <p className="text-xs text-gray-600">
                          Inkomensafhankelijke combinatiekorting voor werkende ouders met kind onder 12 jaar
                        </p>
                      </div>
                    </div>
                  )}
                  {projections?.timeline[0]?.cashflow && (
                    <div className="relative group">
                      <KPICard 
                        icon="üìâ"
                        label="Effectief belastingtarief"
                        value={`${projections.timeline[0].cashflow.effectiveTaxRate.toFixed(1)}%`}
                        color="secondary"
                      />
                      <div className="absolute left-0 top-full mt-2 w-80 bg-white border border-gray-200 rounded-lg shadow-lg p-3 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-10">
                        <p className="text-xs font-semibold text-gray-700 mb-2">Heffingskortingen 2026:</p>
                        <div className="space-y-1 text-xs">
                          <div className="flex justify-between text-green-600">
                            <span>‚úì Algemene heffingskorting (AHK)</span>
                            <span className="font-semibold">Inbegrepen</span>
                          </div>
                          <div className="flex justify-between text-green-600">
                            <span>‚úì Arbeidskorting (AK)</span>
                            <span className="font-semibold">Inbegrepen</span>
                          </div>
                          {projections.timeline[0].cashflow.iack > 0 && (
                            <div className="flex justify-between text-green-600">
                              <span>‚úì IACK (combinatiekorting)</span>
                              <span className="font-semibold">‚Ç¨{projections.timeline[0].cashflow.iack.toFixed(0)}</span>
                            </div>
                          )}
                         {projections.timeline[0].cashflow.hypotheekrenteAftrek > 0 && (
                            <div className="flex justify-between text-blue-600">
                              <span>‚úì Hypotheekrenteaftrek</span>
                              <span className="font-semibold">‚Ç¨{projections.timeline[0].cashflow.hypotheekrenteAftrek.toFixed(0)}</span>
                            </div>
                          )}
                          {projections.timeline[0].cashflow.partner2GrossIncome > 0 && projections.timeline[0].cashflow.hypotheekrenteAftrek > 0 && (
                            <div className="text-xs text-gray-500 italic pl-3">
                              ‚Üí Optimaal toegewezen aan hoogste inkomen
                            </div>
                          )}
                          <div className="border-t pt-1 mt-1">
                            <div className="flex justify-between">
                              <span>Bruto inkomen:</span>
                              <span>{formatCurrency(projections.timeline[0].cashflow.grossIncome)}</span>
                            </div>
                            <div className="flex justify-between text-red-600">
                              <span>Zonder kortingen:</span>
                              <span>{formatCurrency(projections.timeline[0].cashflow.loonheffing)}</span>
                            </div>
                            <div className="flex justify-between text-green-700 font-semibold">
                              <span>Met kortingen:</span>
                              <span>{formatCurrency(projections.timeline[0].cashflow.werkelijkeBelasting)}</span>
                            </div>
                          </div>
                          <div className="flex justify-between font-bold pt-1 border-t">
                            <span>Effectief tarief:</span>
                            <span>{projections.timeline[0].cashflow.effectiveTaxRate.toFixed(1)}%</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                  <KPICard 
                    icon="üíé"
                    label="Totale bezittingen"
                    value={projections?.timeline[0] ? formatCurrency(projections.timeline[0].totalAssets) : formatCurrency(0)}
                    color="primary"
                  />
                  <KPICard 
                    icon="üí≥"
                    label="Totale schulden"
                    value={projections?.timeline[0] ? formatCurrency(projections.timeline[0].totalLiabilities) : formatCurrency(0)}
                    color="secondary"
                  />
                  <KPICard 
                    icon="üèÜ"
                    label="Equity (Woning - Hypotheek)"
                    value={projections?.timeline[0] ? formatCurrency(projections.timeline[0].equity) : formatCurrency(0)}
                    color="accent"
                  />
                </div>
                
                <div className="bg-white rounded-lg shadow p-6">
                  <h2 className="text-lg font-semibold mb-4">Vermogensontwikkeling</h2>
                  {projections ? (
                    <div className="space-y-4">
                      <div className="text-sm text-gray-600">
                        {projections.fireYear ? (
                          <p>üéâ Je bereikt je vermogensdoel in <strong>{projections.fireYear}</strong> (over {projections.yearsToFire} jaar)</p>
                        ) : (
                          <p>‚ö†Ô∏è Met de huidige instellingen bereik je het vermogensdoel niet binnen 50 jaar</p>
                        )}
                      </div>
                      
                      {projections.timeline[0]?.cashflow?.toeslagen > 0 && (
                        <div className="bg-green-50 border-l-4 border-green-500 p-3 rounded">
                          <p className="text-sm text-green-800">
                            <strong>üí° Toeslagen inbegrepen:</strong> Je projectie houdt rekening met {formatCurrency(projections.timeline[0].cashflow.toeslagen)} aan toeslagen per jaar
                          </p>
                        </div>
                      )}
                      
                      <div className="border rounded-lg p-4 bg-gray-50">
                        <div className="text-xs text-gray-500 mb-2">Eerste 10 jaar projectie:</div>
                        <div className="space-y-1">
                          {projections.timeline.slice(0, 10).map((year, index) => (
                            <div key={index} className="group relative">
                              <div className="flex items-center gap-2 text-sm">
                                <span className="w-16 text-gray-600">{year.year}</span>
                                <div className="flex-1 bg-gray-200 rounded-full h-6 relative">
                                  <div 
                                    className="bg-primary h-6 rounded-full flex items-center justify-end pr-2 text-white text-xs font-medium"
                                    style={{ width: `${Math.min(100, (year.netWorth / targetNetWorth) * 100)}%` }}
                                  >
                                    {year.netWorth >= 10000 && formatCurrency(year.netWorth)}
                                  </div>
                                </div>
                                {year.savingsRate !== null && (
                                  <span className="text-xs text-gray-500 w-16 text-right">{year.savingsRate.toFixed(0)}%</span>
                                )}
                                {year.cashflow?.toeslagen > 0 && (
                                  <span className="text-xs text-green-600 w-20 text-right">
                                    +{formatCurrency(year.cashflow.toeslagen)} toeslagen
                                  </span>
                                )}
                              </div>
                              {/* Hover tooltip with breakdown */}
                              <div className="absolute left-20 top-full mt-1 w-80 bg-white border border-gray-300 rounded-lg shadow-lg p-3 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-10">
                                <p className="text-xs font-semibold text-gray-700 mb-2">Vermogensopbouw {year.year}:</p>
                                <div className="space-y-1 text-xs">
                                  <div className="flex justify-between">
                                    <span>üíµ Liquide vermogen (cash/beleggingen):</span>
                                    <span className="font-semibold">{formatCurrency(year.liquidNetWorth)}</span>
                                  </div>
                                  <div className="border-t pt-1 mt-1">
                                    <div className="flex justify-between text-blue-600">
                                      <span>üè† Woningwaarde:</span>
                                      <span className="font-semibold">+{formatCurrency(calculatePropertyValue(assets, year.year))}</span>
                                    </div>
                                    <div className="flex justify-between text-red-600">
                                      <span>üí≥ Hypotheekschuld:</span>
                                      <span className="font-semibold">-{formatCurrency(year.mortgageLiability)}</span>
                                    </div>
                                    <div className="flex justify-between text-green-700 font-semibold">
                                      <span>üèÜ Equity (woning):</span>
                                      <span>{formatCurrency(year.equity)}</span>
                                    </div>
                                  </div>
                                  {(year.totalAssets - calculatePropertyValue(assets, year.year) > 0 || year.otherLiabilities > 0) && (
                                    <div className="border-t pt-1 mt-1">
                                      {year.totalAssets - calculatePropertyValue(assets, year.year) > 0 && (
                                        <div className="flex justify-between text-blue-600">
                                          <span>üíé Overige bezittingen:</span>
                                          <span className="font-semibold">+{formatCurrency(year.totalAssets - calculatePropertyValue(assets, year.year))}</span>
                                        </div>
                                      )}
                                      {year.otherLiabilities > 0 && (
                                        <div className="flex justify-between text-red-600">
                                          <span>üí≥ Overige schulden:</span>
                                          <span className="font-semibold">-{formatCurrency(year.otherLiabilities)}</span>
                                        </div>
                                      )}
                                    </div>
                                  )}
                                  <div className="flex justify-between font-bold pt-1 border-t">
                                    <span>üìä Totaal vermogen:</span>
                                    <span>{formatCurrency(year.netWorth)}</span>
                                  </div>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  ) : (
                    <div className="h-96 flex items-center justify-center text-gray-400">
                      Berekeningen worden uitgevoerd...
                    </div>
                  )}
                </div>
                
              </div>
              
            </div>
          </div>

          <EditDialog
            isOpen={editDialog.isOpen}
            type={editDialog.type}
            item={editDialog.item}
            onSave={saveItem}
            onCancel={() => setEditDialog({ isOpen: false, type: null, item: null })}
          />
          
          <AddIncomeDialog
            isOpen={showIncomeCategoryDialog}
            onSelectCategory={handleIncomeCategorySelect}
            onCancel={() => setShowIncomeCategoryDialog(false)}
          />
          
          <AddExpenseDialog
            isOpen={showCategoryDialog}
            onSelectCategory={handleCategorySelect}
            onCancel={() => setShowCategoryDialog(false)}
          />

          <HousingDialog
            isOpen={housingDialog.isOpen}
            item={housingDialog.item}
            onSave={saveHousing}
            onCancel={() => setHousingDialog({ isOpen: false, item: null })}
          />
          
          <AssetDialog
            isOpen={assetDialog.isOpen}
            item={assetDialog.item}
            onSave={saveAsset}
            onCancel={() => setAssetDialog({ isOpen: false, item: null })}
          />
          
          <LiabilityDialog
            isOpen={liabilityDialog.isOpen}
            item={liabilityDialog.item}
            onSave={saveLiability}
            onCancel={() => setLiabilityDialog({ isOpen: false, item: null })}
          />
        
        </div>
      );
    }
    
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
